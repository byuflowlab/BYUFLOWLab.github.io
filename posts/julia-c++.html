<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Making Julia as Fast as C++ &middot; FLOW Lab
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/my.css">
  <link rel="stylesheet" href="/public/css/academicons.css">
  <link rel="stylesheet" type="text/css" media="screen" href="/public/css/toc.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Icons -->
  <!-- <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"> -->
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/public/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/public/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/public/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/public/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/public/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/public/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/public/apple-touch-icon-152x152.png" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- script -->
  <script type="text/javascript">  // used to hide/show BibTeX blocks
  <!--
      function toggle_visibility(id) {
         var e = document.getElementById(id);
         if(e.style.display == 'block')
            e.style.display = 'none';
         else
            e.style.display = 'block';
      }
  //-->
  </script>

  <!-- mathjax -->
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
  </script>

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134508820-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134508820-1');
  </script>
  


</head>


  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          <img src="/images/logo.png" width="400px" color="white">
          <!-- FLOW Lab -->
        </a>
      </h1>
      <p class="lead">Flight, Optimization, and Wind Laboratory</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      <a class="sidebar-nav-item" href="/publications">Publications</a>
      <a class="sidebar-nav-item" href="/posts">Posts</a>
      <a class="sidebar-nav-item" href="/people">People</a>
      <a class="sidebar-nav-item" href="/research">Research</a>
      <a class="sidebar-nav-item" href="/teaching">Teaching</a>
      <a class="sidebar-nav-item" href="/resources">Resources</a>
      
    </nav>

    <p>&copy; 2019. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Making Julia as Fast as C++</h1>
  <span class="post-date">18 Apr 2019, Eduardo Alvarez</span>
  <center>
<img src="/posts/vortex00.gif" alt="Vid here" width="500px" />
</center>

<h2 id="introduction">Introduction</h2>

<p>The rumor says that Julia can achieve the <a href="https://julialang.org/benchmarks/">same computing
performance</a> as any other compiled language
like C++ and FORTRAN. After coding in Julia for the past two years I have
definitely fell in love with its pythonic syntax, multiple dispatch, and MATLAB-like
handiness in linear algebra, while being able to use compilation features
like explicit type declaration for bug-preventive programming. In summary,
Julia’s philosophy brings all the flexibility of an interpreted language,
meanwhile its Just-In-Time (JIT) compilation makes it a defacto
compiled language.</p>

<p>Julia’s high level syntax makes the language easygoing for programmers from any
background, however, achieving high performance is sort of
an art. In this post I summarize some of the things I’ve learned while crafting
my Julia codes for high-performance computing. I will attempt to show the
process of code optimization through a real-world computing application from
aerodynamics: the <a href="https://scholarsarchive.byu.edu/facpub/2116/">vortex particle
method</a><script type="math/tex">^{[1,\,2]}</script>.</p>

<h2 id="problem-definition">Problem Definition</h2>

<p>In the <a href="https://scholarsarchive.byu.edu/facpub/2116/">vortex particle method</a> we
are interested in calculating the velocity <script type="math/tex">\mathbf{u}</script> and velocity Jacobian
<script type="math/tex">\mathbf{J}</script> that a field of <script type="math/tex">N</script> vortex particles induces at an arbitrary
position <script type="math/tex">\mathbf{x}</script>. This is calculated as</p>

<script type="math/tex; mode=display">{\bf u}\left( {\bf x} \right) = \sum\limits_p^N g_\sigma\left(
{\bf x}-{\bf x}_p \right)
                                                {\bf K}\left( {\bf x}-{\bf x}_p
\right)   \times
                                    \boldsymbol\Gamma_p</script>

<script type="math/tex; mode=display">\frac{\partial {\bf u}}{\partial x_j}\left( {\bf x} \right)
        = \sum\limits_p^N \left[
            \left(
                \frac{1}{\sigma }
                 \frac{\Delta x_j}{\Vert \Delta \mathbf{x} \Vert}
                 \frac{\partial g}{\partial r}
                 \left(
                             \frac{\Vert \Delta\mathbf{x} \Vert}{\sigma}
                 \right) -
                 3 g_\sigma\left( \Delta{\bf x} \right)
                 \frac{\Delta x_j}{\Vert \Delta\mathbf{x} \Vert^2}
            \right)
            {\bf K}\left( \Delta\mathbf{x} \right)  \times \boldsymbol\Gamma_p -
            \frac{g_\sigma\left( \Delta{\bf x} \right) }{4\pi \Vert \Delta{\bf
x} \Vert^3}
            \delta_{ij} \times \boldsymbol\Gamma_p
        \right]
,</script>

<p>with <script type="math/tex">{\bf K}</script> the singular Newtonian kernel <script type="math/tex">{\bf K}\left( {\bf x}\right)=-\frac{ {\bf x} }{4\pi \Vert{\bf x}\Vert^3}</script>, <script type="math/tex">g_\sigma</script> a regularizing
function of smoothing radius <script type="math/tex">\sigma</script>, and <script type="math/tex">\mathbf{x}_p</script> and
<script type="math/tex">\boldsymbol{\Gamma}_p</script> the position and vectorial strength of the <script type="math/tex">p</script>-th
particle, respectively. Furthermore, the governing equations of the method
require evaluating the velocity <script type="math/tex">\mathbf{u}</script> and Jacobian <script type="math/tex">\mathbf{J}</script> that the
collection of particles induces on itself, leading to the well-known <a href="https://en.wikipedia.org/wiki/N-body_problem"><script type="math/tex">N</script>-body
problem</a> of computational
complexity <script type="math/tex">\mathcal{O}(N^2)</script>.</p>

<p>Choosing Winckelmans’ regularizing kernel<script type="math/tex">^{[1]}</script></p>

<script type="math/tex; mode=display">g(r) = r^3 \frac{r^2 + 5/2}{\left( r^2 + 1 \right)^{5/2}}</script>

<script type="math/tex; mode=display">\frac{\partial g}{\partial r} (r) = \frac{15}{2}
            \frac{r^2}{\left( r^2 + 1 \right)^{7/2}}
,</script>

<p>the above equations are implemented in C++ as follows:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Particle-to-particle interactions</span>
<span class="kt">void</span> <span class="nf">P2P</span><span class="p">(</span><span class="n">Particle</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">numParticles</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">real_t</span> <span class="n">r</span><span class="p">,</span> <span class="n">ros</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">g_sgm</span><span class="p">,</span> <span class="n">dgdr</span><span class="p">;</span>
  <span class="n">vec3</span> <span class="n">dX</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
          <span class="n">ros</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="p">;</span>

          <span class="c1">// Evaluate g_σ and ∂gσ∂r</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span>
          <span class="n">g_sgm</span> <span class="o">=</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">dgdr</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">/</span> <span class="p">(</span> <span class="n">aux</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">);</span>

          <span class="c1">// u(x) = ∑g_σ(x−xp) K(x−xp) × Γp</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="n">g_sgm</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>

          <span class="c1">// ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp]</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">dgdr</span><span class="o">/</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">g_sgm</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">));</span>
          <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">){</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="c1">// Adds the Kronecker delta term</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span> <span class="n">const4</span> <span class="o">*</span> <span class="n">g_sgm</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">);</span>
          <span class="c1">// k=1</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="c1">// k=2</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="c1">// k=3</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>The figure at the top of the page is a simulation of a 6x6x6 box of particles with vorticity
initially concentrated at its center, diffusing as the simulation progresses due
to viscous effects:
<!-- <center>
<img src="vortex00.gif" alt="Vid here" width="500px">
</center> --></p>

<h2 id="c-benchmark">C++ Benchmark</h2>

<p>Here I have <a href="https://github.com/EdoAlvarezR/post-juliavscpp">coded a benchmark</a>
of the C++ code shown above, evaluating <code class="highlighter-rouge">P2P</code> on a box of 6x6x6=216 particles,
and made it callable in this notebook through the
<a href="https://github.com/JuliaInterop/CxxWrap.jl">CxxWrap</a> Julia package:</p>

<p><strong>In [1]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="cm">#=
    This cell loads auxiliary benchmarking functions available
    here: https://github.com/EdoAlvarezR/post-juliavscpp
=#</span>

<span class="k">using</span> <span class="n">LinearAlgebra</span>

<span class="c"># Load C++ code wrapped as module CxxVortexTest</span>
<span class="n">include</span><span class="x">(</span><span class="s">"code/vortextest.jl"</span><span class="x">)</span>

<span class="c"># Load benchmarking tools</span>
<span class="n">include</span><span class="x">(</span><span class="s">"code/benchmarking.jl"</span><span class="x">);</span></code></pre></figure>

<p><strong>In [2]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">ntests</span> <span class="o">=</span> <span class="mi">1000</span>               <span class="c"># Tests to run</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>                       <span class="c"># Particles per side</span>
<span class="n">lambda</span> <span class="o">=</span> <span class="mf">1.5</span>                <span class="c"># Core overlap</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="nb">true</span>

<span class="c"># Run C++ benchmark</span>
<span class="n">cpptime</span> <span class="o">=</span> <span class="n">CxxVortexTest</span><span class="o">.</span><span class="n">benchmarkP2P_wrap</span><span class="x">(</span><span class="n">ntests</span><span class="x">,</span> <span class="n">n</span><span class="x">,</span> <span class="kt">Float32</span><span class="x">(</span><span class="n">lambda</span><span class="x">),</span> <span class="n">verbose</span><span class="x">)</span>

<span class="c"># Store benchmark result</span>
<span class="n">benchtime</span><span class="x">[</span><span class="s">"C++"</span><span class="x">]</span> <span class="o">=</span> <span class="n">cpptime</span><span class="x">;</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Samples:	1000
min time:	3.99555 ms
ave time:	4.77778 ms
max time:	6.73414 ms
</code></pre></div></div>

<p>This was ran in my Dell Latitude 5580 laptop (Intel® Core™ i7-7820HQ CPU @
2.90GHz × 8 ) in only one process, and we see that <strong>the C++ kernel, best-case
scenario, is evaluated in ~4 ms</strong>. Let’s move on and code this up in Julia.</p>

<p><strong>NOTE:</strong> The C++ code was compiled with the <code class="highlighter-rouge">-O3</code> flag for code optimization.</p>

<h2 id="optimizing-julia">Optimizing Julia</h2>

<h3 id="julia-baseline-pythonic-programming">Julia Baseline: Pythonic Programming</h3>

<p>Tempted by the Python-like syntax available in Julia, our first inclination is
to make the code as general, simple, and easy to understand as possible. Here is
the most general implementation where no types are specified:</p>

<p><strong>In [3]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
This is a particle struct made up of ambiguous (unspecified) types
"""</span>
<span class="k">struct</span> <span class="n">ParticleAmbiguous</span>

    <span class="c"># User inputs</span>
    <span class="n">X</span>                               <span class="c"># Position</span>
    <span class="n">Gamma</span>                           <span class="c"># Vectorial circulation</span>
    <span class="n">sigma</span>                           <span class="c"># Smoothing radius</span>

    <span class="c"># Properties</span>
    <span class="n">U</span>                               <span class="c"># Velocity at particle</span>
    <span class="n">J</span>                               <span class="c"># Jacobian at particle J[i,j]=dUi/dxj</span>

    <span class="n">ParticleAmbiguous</span><span class="x">(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">;</span> <span class="n">U</span><span class="o">=</span><span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">),</span> <span class="n">J</span><span class="o">=</span><span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">,</span><span class="mi">3</span><span class="x">)</span>
                      <span class="x">)</span> <span class="o">=</span> <span class="n">new</span><span class="x">(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span> <span class="x">)</span>
<span class="k">end</span>

<span class="c"># Empty initializer</span>
<span class="n">Base</span><span class="o">.</span><span class="n">zero</span><span class="x">(</span><span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="o">&lt;:</span><span class="n">ParticleAmbiguous</span><span class="x">})</span> <span class="o">=</span> <span class="n">ParticleAmbiguous</span><span class="x">(</span><span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">),</span> <span class="mf">0.0</span><span class="x">)</span>




<span class="c"># Winckelmans regularizing kernel</span>
<span class="n">g_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.5</span><span class="x">)</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">2.5</span>
<span class="n">dgdr_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">3.5</span>

<span class="kd">const</span> <span class="n">const4</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="x">(</span><span class="mi">4</span><span class="o">*</span><span class="nb">pi</span><span class="x">)</span>




<span class="s">"""
    Pythonic programming approach
"""</span>
<span class="k">function</span><span class="nf"> P2P_pythonic</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">dX</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss</span> <span class="o">=</span> <span class="n">cross</span><span class="x">(</span><span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="x">(</span><span class="n">dX</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">),</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="o">:</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
                    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="n">const4</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">)</span> <span class="o">*</span> <span class="n">cross</span><span class="x">([</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="x">],</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span> <span class="x">)</span>
                <span class="k">end</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [4]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Create a 6x6x6 box of ambiguous particles</span>
<span class="n">particles_amb</span> <span class="o">=</span> <span class="n">generate_particles</span><span class="x">(</span><span class="n">ParticleAmbiguous</span><span class="x">,</span> <span class="n">n</span><span class="x">,</span> <span class="n">lambda</span><span class="x">)</span>

<span class="c"># Run benchmark</span>
<span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles_amb</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_pythonic</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="n">args</span><span class="x">;</span> <span class="n">reverse</span><span class="o">=</span><span class="nb">false</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_pythonic</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is 58.48 times faster than         P2P_pythonic (3.996ms vs 233.679ms)

BenchmarkTools.Trial:
  memory estimate:  217.57 MiB
  allocs estimate:  4087152
  --------------
  minimum time:     233.679 ms (5.04% GC)
  median time:      238.482 ms (4.99% GC)
  mean time:        251.540 ms (9.28% GC)
  maximum time:     295.517 ms (19.89% GC)
  --------------
  samples:          4
  evals/sample:     1
</code></pre></div></div>

<p>Here we see that in our pythonic attempt we’ve got code that is <strong>pretty neat
and concise, but ~58x slower than the C++ implementation</strong>.</p>

<h3 id="fix-1-always-work-with-concrete-types">Fix #1: Always work with concrete types</h3>

<p>The problem with the pythonic approach is that variable types are never
declared, and <strong>without foreknowledge of the types to be handled, Julia can’t
optimize the function during compilation</strong>. In order to help us catch ambiguous
(abstract) types in our code, the Julia <code class="highlighter-rouge">Base</code> package provides the macro
<code class="highlighter-rouge">@code_warntype</code>, which prints the lowered and type-inferred AST used during
compilation highlighting any abstract types encountered.</p>

<p>The output is pretty lengthy, so here I have copied and pasted only a snippet:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@code_warntype</span> <span class="n">P2P_pythonic</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">)</span>

<span class="n">Body</span><span class="o">::</span><span class="kt">Nothing</span>
<span class="n">│╻╷╷</span>  <span class="n">iterate34</span> <span class="mi">1</span> <span class="n">──</span> <span class="o">%</span><span class="mi">1</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">arraylen</span><span class="x">)(</span><span class="n">particles</span><span class="x">)</span><span class="o">::</span><span class="kt">Int64</span>
<span class="n">││╻╷</span>   <span class="n">iterate</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">2</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">sle_int</span><span class="x">)(</span><span class="mi">0</span><span class="x">,</span> <span class="o">%</span><span class="mi">1</span><span class="x">)</span><span class="o">::</span><span class="kt">Bool</span>
<span class="n">│││╻</span>    <span class="o">&lt;</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">3</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">bitcast</span><span class="x">)(</span><span class="kt">UInt64</span><span class="x">,</span> <span class="o">%</span><span class="mi">1</span><span class="x">)</span><span class="o">::</span><span class="kt">UInt64</span>
<span class="n">││││╻</span>    <span class="o">&lt;</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">4</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">ult_int</span><span class="x">)(</span><span class="mh">0x0000000000000000</span><span class="x">,</span> <span class="o">%</span><span class="mi">3</span><span class="x">)</span><span class="o">::</span><span class="kt">Bool</span>
<span class="n">││││╻</span>    <span class="o">&amp;</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">5</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">and_int</span><span class="x">)(</span><span class="o">%</span><span class="mi">2</span><span class="x">,</span> <span class="o">%</span><span class="mi">4</span><span class="x">)</span><span class="o">::</span><span class="kt">Bool</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
<span class="n">│</span>       <span class="mi">11</span> <span class="n">┄</span> <span class="o">%</span><span class="mi">33</span>  <span class="o">=</span> <span class="n">φ</span> <span class="x">(</span><span class="c">#10 =&gt; %28, #34 =&gt; %149)::ParticleAmbiguous</span>
<span class="n">│</span>       <span class="n">│</span>    <span class="o">%</span><span class="mi">34</span>  <span class="o">=</span> <span class="n">φ</span> <span class="x">(</span><span class="c">#10 =&gt; %29, #34 =&gt; %150)::Int64</span>
<span class="n">│╻</span>    <span class="n">getproperty37</span> <span class="n">│</span>    <span class="o">%</span><span class="mi">35</span>  <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">getfield</span><span class="x">)(</span><span class="o">%</span><span class="mi">16</span><span class="x">,</span> <span class="o">:</span><span class="n">X</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
<span class="n">││</span>      <span class="n">│</span>    <span class="o">%</span><span class="mi">36</span>  <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">getfield</span><span class="x">)(</span><span class="o">%</span><span class="mi">33</span><span class="x">,</span> <span class="o">:</span><span class="n">X</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
<span class="n">│</span>       <span class="n">│</span>    <span class="o">%</span><span class="mi">37</span>  <span class="o">=</span> <span class="x">(</span><span class="o">%</span><span class="mi">35</span> <span class="o">-</span> <span class="o">%</span><span class="mi">36</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
<span class="n">│</span>    <span class="mi">38</span> <span class="n">│</span>    <span class="o">%</span><span class="mi">38</span>  <span class="o">=</span> <span class="x">(</span><span class="n">Main</span><span class="o">.</span><span class="n">norm</span><span class="x">)(</span><span class="o">%</span><span class="mi">37</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
</code></pre></div></div>

<p>Understanding this lowered AST syntax is sort of an art, but you’ll soon learn
that <code class="highlighter-rouge">@code_warntype</code> is your best friend when optimizing code. As we scroll
down the AST we see that code encounters types <code class="highlighter-rouge">Any</code> in the properties of our
<code class="highlighter-rouge">ParticleAmbiguous</code> type, which immediately should raise a red flag to us (<code class="highlighter-rouge">Any</code>
is an abstract type). In fact, when running <code class="highlighter-rouge">@code_warntype</code> the output
automatically highlights those <code class="highlighter-rouge">::Any</code> asserts in red.</p>

<p>We can take care of those abstract types by defining the properties of the
<a href="https://docs.julialang.org/en/v1/manual/performance-
tips/index.html#Type-declarations-1">struct parametrically</a>:</p>

<p><strong>In [5]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
This is a particle struct with property types
explicitely/parametrically defined.
"""</span>
<span class="k">struct</span> <span class="n">Particle</span><span class="x">{</span><span class="n">T</span><span class="x">}</span>

  <span class="c"># User inputs</span>
  <span class="n">X</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">1</span><span class="x">}</span>                <span class="c"># Position</span>
  <span class="n">Gamma</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">1</span><span class="x">}</span>            <span class="c"># Vectorial circulation</span>
  <span class="n">sigma</span><span class="o">::</span><span class="n">T</span>                      <span class="c"># Smoothing radius</span>

  <span class="c"># Properties</span>
  <span class="n">U</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">1</span><span class="x">}</span>                <span class="c"># Velocity at particle</span>
  <span class="n">J</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">2</span><span class="x">}</span>                <span class="c"># Jacobian at particle J[i,j]=dUi/dxj</span>

<span class="k">end</span>

<span class="c"># Another initializer alias</span>
<span class="n">Particle</span><span class="x">{</span><span class="n">T</span><span class="x">}(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">)</span> <span class="n">where</span> <span class="x">{</span><span class="n">T</span><span class="x">}</span> <span class="o">=</span> <span class="n">Particle</span><span class="x">(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">,</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span><span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">))</span>

<span class="c"># Empty initializer</span>
<span class="n">Base</span><span class="o">.</span><span class="n">zero</span><span class="x">(</span><span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="o">&lt;:</span><span class="n">Particle</span><span class="x">{</span><span class="n">T</span><span class="x">}})</span> <span class="n">where</span> <span class="x">{</span><span class="n">T</span><span class="x">}</span> <span class="o">=</span> <span class="n">Particle</span><span class="x">(</span><span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">),</span>
                                                      <span class="n">zero</span><span class="x">(</span><span class="n">T</span><span class="x">),</span>
                                                      <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">))</span></code></pre></figure>

<p>No modifications further are needed in our <code class="highlighter-rouge">P2P_pythonic</code> function since Julia’s
multiple dispatch and JIT automatically compiles a version of the function
specialized for our new <code class="highlighter-rouge">Particle{T}</code> type on the fly. Still, we will define an
alias to help us compare benchmarks:</p>

<p><strong>In [6]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">P2P_concretetypes</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">)</span> <span class="o">=</span> <span class="n">P2P_pythonic</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">)</span></code></pre></figure>

<p><strong>In [7]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Create a 6x6x6 box of concrete Float64 particles</span>
<span class="n">particles</span> <span class="o">=</span> <span class="n">generate_particles</span><span class="x">(</span><span class="n">Particle</span><span class="x">{</span><span class="kt">Float64</span><span class="x">},</span> <span class="n">n</span><span class="x">,</span> <span class="n">lambda</span><span class="x">)</span>

<span class="c"># Run benchmark</span>
<span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_concretetypes</span><span class="x">,</span> <span class="n">P2P_pythonic</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_concretetypes</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_concretetypes    is  3.06 times faster than         P2P_pythonic (76.488ms vs 233.679ms)

BenchmarkTools.Trial:
  memory estimate:  189.93 MiB
  allocs estimate:  2275776
  --------------
  minimum time:     76.488 ms (13.63% GC)
  median time:      77.860 ms (13.79% GC)
  mean time:        84.567 ms (17.89% GC)
  maximum time:     145.918 ms (42.64% GC)
  --------------
  samples:          12
  evals/sample:     1
</code></pre></div></div>

<p>Voilà! By specifying concrete types in our <code class="highlighter-rouge">Particle</code> struct now we have gained
a 3x speed up (we should run <code class="highlighter-rouge">@code_warntype</code> again to make sure we got rid of
all abstract types, but I’ll omit it for brevity).</p>

<p>Let’s new see how we compare to C++:</p>

<p><strong>In [8]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_concretetypes</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is 19.14 times faster than    P2P_concretetypes (3.996ms vs 76.488ms)
</code></pre></div></div>

<p>Working with concrete types greatly sped up the computation; however, the C++
version is still ~20x faster than Julia. Let’s see what else can we optimize.</p>

<h3 id="fix-2-avoid-list-comprehensions">Fix #2: Avoid List Comprehensions</h3>

<p>The wonders of list comprehension may tempt you to write some line-efficient
code; however, loosely used may lead to a very inefficient
computation. Take for example this list-comprehension sum:</p>

<p><strong>In [9]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">sum_list</span><span class="x">(</span><span class="n">n</span><span class="x">)</span> <span class="o">=</span> <span class="n">sum</span><span class="x">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="x">])</span>

<span class="nd">@btime</span> <span class="n">sum_list</span><span class="x">(</span><span class="mi">100</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  80.975 ns (1 allocation: 896 bytes)
</code></pre></div></div>

<p>Here is the version of the same function unrolled without the list
comprehension, which does the job 60 times faster:</p>

<p><strong>In [10]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> sum_unrolled</span><span class="x">(</span><span class="n">n</span><span class="x">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">out</span>
<span class="k">end</span>

<span class="nd">@btime</span> <span class="n">sum_unrolled</span><span class="x">(</span><span class="mi">100</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1.374 ns (0 allocations: 0 bytes)
</code></pre></div></div>

<p>In our P2P function we have a Kronecker delta cross product that we were
calculating in just one line as a list comprehension as</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
        <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                          <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="o">-</span>
                          <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="n">const4</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">)</span> <span class="o">*</span> <span class="n">cross</span><span class="x">([</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="x">],</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span> <span class="x">)</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>The alternative is to expand it into a few lines as</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
        <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                          <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="x">)</span>
    <span class="k">end</span>

    <span class="c"># ∂u∂xj(x) = −∑gσ/(4πr^3) δij×Γp</span>
    <span class="c"># Adds the Kronecker delta term</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
    <span class="c"># j=1</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
    <span class="c"># j=2</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
    <span class="c"># j=3</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
</code></pre></div></div>

<p>The problem with list comprehension operations is that it has to allocate memory
to build the generated array. Just resist the temptation of using list
comprehensions to save yourself a few lines, and simply unroll it. As seen below
we get a 1.5x speed up by unrolling this line:</p>

<p><strong>In [11]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    Unrolling the list comprehension
"""</span>
<span class="k">function</span><span class="nf"> P2P_nocomprehension</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">dX</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss</span> <span class="o">=</span> <span class="n">cross</span><span class="x">(</span><span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="x">(</span><span class="n">dX</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">),</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="o">:</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
                    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="x">)</span>
                <span class="k">end</span>

                <span class="c"># ∂u∂xj(x) += −∑gσ/(4πr^3) δij×Γp</span>
                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [12]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_nocomprehension</span><span class="x">,</span> <span class="n">P2P_concretetypes</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_nocomprehension</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_nocomprehension  is  1.52 times faster than    P2P_concretetypes (50.196ms vs 76.488ms)

BenchmarkTools.Trial:
  memory estimate:  126.16 MiB
  allocs estimate:  1300536
  --------------
  minimum time:     50.196 ms (11.28% GC)
  median time:      51.929 ms (11.65% GC)
  mean time:        55.319 ms (15.41% GC)
  maximum time:     107.039 ms (50.23% GC)
  --------------
  samples:          19
  evals/sample:     1
</code></pre></div></div>

<h3 id="fix-3-reduce-allocation">Fix #3: Reduce Allocation</h3>

<p>Next, we notice that the benchmarking test is allotting an unusual amount of
memory (126MiB) and allocation operations (1.3M). I am suspicious that this is
an issue with Julia allowing arrays of dynamic sizes. The first step to solve
this is to <strong>do away with creating any internal variables of type arrays</strong>. In
the code bellow, notice that I had replaced the array variables <code class="highlighter-rouge">dX</code> and <code class="highlighter-rouge">crss</code>
with float variables <code class="highlighter-rouge">dX1, dX2, dX3</code>, and <code class="highlighter-rouge">crss1, crss2, crss3</code>, which leads to
having to fully unroll the inner for-loop:</p>

<p><strong>In [13]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    Reducing memory allocation
"""</span>
<span class="k">function</span><span class="nf"> P2P_noallocation</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
            <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
            <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss1</span><span class="x">,</span> <span class="n">crss2</span><span class="x">,</span> <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cross</span><span class="x">(</span><span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">,</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [14]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_noallocation</span><span class="x">,</span> <span class="n">P2P_nocomprehension</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_noallocation</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_noallocation     is  3.68 times faster than  P2P_nocomprehension (13.627ms vs 50.196ms)

BenchmarkTools.Trial:
  memory estimate:  21.99 MiB
  allocs estimate:  325296
  --------------
  minimum time:     13.627 ms (7.41% GC)
  median time:      15.615 ms (8.40% GC)
  mean time:        16.582 ms (12.83% GC)
  maximum time:     59.011 ms (66.91% GC)
  --------------
  samples:          61
  evals/sample:     1
</code></pre></div></div>

<p>Here we have reduced the memory allocated from 126MiB to 22MiB, leading to a
3.5x speed up. Let’s see what else can we do to decrease memory allocation.</p>

<h3 id="fix-4-no-linear-algebra">Fix #4: No Linear Algebra</h3>

<p>The next thing to consider is that doing <strong>linear algebra operations
using the Julia base library (i.e., <code class="highlighter-rouge">dot(X,X)</code>,
<code class="highlighter-rouge">cross(X,X)</code>, <code class="highlighter-rouge">norm(X,X)</code>) is more expensive that explicitely unfolding the
operation into lines of code</strong>. I am suspicious that this is a memory allocation
problem since these functions need to allocate internal arrays to store the
computation prior to outputting the result. Here is the code without any
functional linear algebra functions from the base library (notice that I no longer use <code class="highlighter-rouge">norm()</code> nor
<code class="highlighter-rouge">cross()</code>):</p>

<p><strong>In [15]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    No linear algebra functions
"""</span>
<span class="k">function</span><span class="nf"> P2P_nolinalg</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
            <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
            <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [16]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_nolinalg</span><span class="x">,</span> <span class="n">P2P_noallocation</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_nolinalg</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_nolinalg         is  2.10 times faster than     P2P_noallocation (6.487ms vs 13.627ms)

BenchmarkTools.Trial:
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     6.487 ms (0.00% GC)
  median time:      7.140 ms (0.00% GC)
  mean time:        7.198 ms (0.00% GC)
  maximum time:     9.172 ms (0.00% GC)
  --------------
  samples:          139
  evals/sample:     1
</code></pre></div></div>

<p>By doing away with linear algebra functions we are now <strong>not allocating any
memory, reaching an extra 2x speed up</strong>.</p>

<h3 id="fix-5-fine-tuning">Fix #5: Fine Tuning</h3>

<p>Notice that by now we are achieving benchmarks in the same order of magnitude
than C++ (6.5ms in Julia vs 4.0ms in C++):</p>

<p><strong>In [17]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_nolinalg</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is  1.62 times faster than         P2P_nolinalg (3.996ms vs 6.487ms)
</code></pre></div></div>

<p>What we did prior to this point were
general principles that apply to any code that attempts to get high performance.
What it follows now is fine tuning of our code in ways that only apply to the
specific computation that we are performing.</p>

<p>For instance, recall that our P2P function receives any user-defined
regularizing kernel that our function calls through this lines:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="nf"> P2P</span><span class="x">(</span><span class="n">sources</span><span class="x">,</span> <span class="n">targets</span><span class="x">,</span> <span class="n">g</span><span class="o">::</span><span class="n">Function</span><span class="x">,</span> <span class="n">dgdr</span><span class="o">::</span><span class="n">Function</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">targets</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">sources</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="c"># g_σ and ∂gσ∂r</span>
            <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
            <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="o">.</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For the case of Winckelmans’ kernel, <code class="highlighter-rouge">g</code> and <code class="highlighter-rouge">dgdr</code> look like this:</p>
<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.5</span><span class="x">)</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">2.5</span>
<span class="n">dgdr_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">3.5</span>
</code></pre></div></div>

<p>We notice that each of these function calculate a power operation independently,
<code class="highlighter-rouge">(r^2 + 1)^2.5</code> and <code class="highlighter-rouge">(r^2 + 1)^3.5</code>. I have observed that <strong>any sort of non-integer
power operation takes Julia more than any basic arithmetic operation or
even space allocation</strong>. Thus, we can save computation by merging this two functions
and reusing the square root calculation as</p>

<p><strong>In [45]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> g_dgdr_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">2.5</span>

    <span class="c"># Returns g and dgdr</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="o">*</span><span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.5</span><span class="x">)</span><span class="o">/</span><span class="n">aux</span><span class="x">,</span> <span class="mf">7.5</span><span class="o">*</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="o">/</span><span class="x">(</span><span class="n">aux</span><span class="o">*</span><span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">))</span>
<span class="k">end</span>

<span class="s">"""
    Reuses sqrt, reducing to only one power calculation
"""</span>
<span class="k">function</span><span class="nf"> P2P_reusesqrt</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
            <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
            <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span><span class="x">,</span> <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">g_dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [19]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_reusesqrt</span><span class="x">,</span> <span class="n">P2P_nolinalg</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_reusesqrt</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_reusesqrt        is  1.60 times faster than         P2P_nolinalg (4.050ms vs 6.487ms)

BenchmarkTools.Trial:
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     4.050 ms (0.00% GC)
  median time:      4.479 ms (0.00% GC)
  mean time:        4.493 ms (0.00% GC)
  maximum time:     5.361 ms (0.00% GC)
  --------------
  samples:          223
  evals/sample:     1
</code></pre></div></div>

<p>Hence, by <strong>simply avoiding one extra power calculation we have now gained a
1.6x speed up.</strong></p>

<h3 id="final-fix-inbounds-simd-fastmath">Final Fix: <code class="highlighter-rouge">@inbounds</code>, <code class="highlighter-rouge">@simd</code>, <code class="highlighter-rouge">@fastmath</code></h3>

<p>This is straight from the Julia official documentation:</p>

<p><a href="https://docs.julialang.org/en/v1/devdocs/boundscheck/index.html"><code class="highlighter-rouge">@inbounds</code></a></p>
<blockquote>
  <p>Like many modern programming languages, Julia uses bounds checking to ensure
program safety when accessing arrays. In tight inner loops or other performance
critical situations, you may wish to skip these bounds checks to improve runtime
performance. For instance, in order to emit vectorized (SIMD) instructions, your
loop body cannot contain branches, and thus cannot contain bounds checks.
Consequently, Julia includes an @inbounds(…) macro to tell the compiler to
skip such bounds checks within the given block. User-defined array types can use
the @boundscheck(…) macro to achieve context-sensitive code selection.</p>
</blockquote>

<p><a href="https://docs.julialang.org/en/v1/manual/performance-tips/index.html
#man-performance-annotations-1"><code class="highlighter-rouge">@simd</code></a></p>
<blockquote>
  <p>Write @simd in front of for loops to promise that the iterations are
independent and may be reordered. Note that in many cases, Julia can
automatically vectorize code without the @simd macro; it is only beneficial in
cases where such a transformation would otherwise be illegal, including cases
like allowing floating-point re-associativity and ignoring dependent memory
accesses (@simd ivdep). Again, be very careful when asserting @simd as
erroneously annotating a loop with dependent iterations may result in unexpected
results. In particular, note that setindex! on some AbstractArray subtypes is
inherently dependent upon iteration order. This feature is experimental and
could change or disappear in future versions of Julia.</p>
</blockquote>

<p><a href="https://docs.julialang.org/en/v1/manual/performance-
tips/index.html#man-performance-annotations-1"><code class="highlighter-rouge">@fastmath</code></a></p>
<blockquote>
  <p>Use @fastmath to allow floating point optimizations that are correct for real
numbers, but lead to differences for IEEE numbers. Be careful when doing this,
as this may change numerical results. This corresponds to the -ffast-math option
of clang.</p>
</blockquote>

<p>I won’t dive into details, but what I have realized is that you can get a speed
up from the three macros listed above only when you are working with <a href="https://docs.julialang.org/en/v1/devdocs/isbitsunionarrays/">data
structures that pass the <code class="highlighter-rouge">isbits</code>
test</a>. In practice,
that means that our structs can’t contain any arrays, which lead us to
redefining the struct as follows:</p>

<p><strong>In [30]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">struct</span> <span class="n">ParticleNoArr</span><span class="x">{</span><span class="n">T</span><span class="x">}</span>

  <span class="c"># User inputs</span>
  <span class="n">X1</span><span class="o">::</span><span class="n">T</span>
  <span class="n">X2</span><span class="o">::</span><span class="n">T</span>
  <span class="n">X3</span><span class="o">::</span><span class="n">T</span>
  <span class="n">Gamma1</span><span class="o">::</span><span class="n">T</span>
  <span class="n">Gamma2</span><span class="o">::</span><span class="n">T</span>
  <span class="n">Gamma3</span><span class="o">::</span><span class="n">T</span>
  <span class="n">sigma</span><span class="o">::</span><span class="n">T</span>

<span class="k">end</span>

<span class="c"># Empty initializer</span>
<span class="n">Base</span><span class="o">.</span><span class="n">zero</span><span class="x">(</span><span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="o">&lt;:</span><span class="n">ParticleNoArr</span><span class="x">{</span><span class="n">T</span><span class="x">}})</span> <span class="n">where</span> <span class="x">{</span><span class="n">T</span><span class="x">}</span> <span class="o">=</span> <span class="n">ParticleNoArr</span><span class="x">(</span><span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">7</span><span class="x">)</span><span class="o">...</span><span class="x">)</span>

<span class="c"># Another initializer alias</span>
<span class="n">ParticleNoArr</span><span class="x">{</span><span class="n">T</span><span class="x">}(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">)</span> <span class="n">where</span> <span class="n">T</span> <span class="o">=</span> <span class="n">ParticleNoArr</span><span class="x">(</span><span class="n">X</span><span class="o">...</span><span class="x">,</span> <span class="n">Gamma</span><span class="o">...</span><span class="x">,</span> <span class="n">sigma</span><span class="x">);</span></code></pre></figure>

<p>With that twist, now we implement <code class="highlighter-rouge">@simd</code> in the internal for loop, while both
<code class="highlighter-rouge">@fastmath</code> and <code class="highlighter-rouge">@inbounds</code> wrap all floating point operations and output
allocation:</p>

<p><strong>In [50]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    Implementation of @simd, @fastmath, and @inbounds
"""</span>
<span class="k">function</span><span class="nf"> P2P_FINAL</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span><span class="x">)</span>

    <span class="k">for</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="n">Pi</span><span class="x">)</span> <span class="k">in</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">particles</span><span class="x">)</span>
        <span class="nd">@simd</span> <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>

            <span class="nd">@fastmath</span> <span class="nd">@inbounds</span> <span class="k">begin</span>
                <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X1</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X1</span>
                <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X2</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X2</span>
                <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X3</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X3</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

                <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                    <span class="c"># g_σ and ∂gσ∂r</span>
                    <span class="n">gsgm</span><span class="x">,</span> <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">g_dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                    <span class="c"># K × Γp</span>
                    <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="x">)</span>
                    <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="x">)</span>
                    <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="x">)</span>

                    <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                    <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                    <span class="c"># Adds the Kronecker delta term</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>

                <span class="k">end</span>
            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [51]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Create a 6x6x6 box of particles of our new ParticleNoArr struct</span>
<span class="n">particlesNoArr</span> <span class="o">=</span> <span class="n">generate_particles</span><span class="x">(</span><span class="n">ParticleNoArr</span><span class="x">{</span><span class="kt">Float64</span><span class="x">},</span> <span class="n">n</span><span class="x">,</span> <span class="n">lambda</span><span class="x">)</span>

<span class="c"># Pre-allocate outputs in separate arrays</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="x">(</span><span class="kt">Float64</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">length</span><span class="x">(</span><span class="n">particlesNoArr</span><span class="x">)</span> <span class="x">)</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">zeros</span><span class="x">(</span><span class="kt">Float64</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">length</span><span class="x">(</span><span class="n">particlesNoArr</span><span class="x">)</span> <span class="x">)</span>

<span class="c"># Run benchmark</span>
<span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particlesNoArr</span><span class="x">,</span> <span class="n">g_dgdr_wnk</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="n">P2P_reusesqrt</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_FINAL</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_FINAL            is  1.14 times faster than        P2P_reusesqrt (3.552ms vs 4.050ms)

BenchmarkTools.Trial:
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     3.552 ms (0.00% GC)
  median time:      4.090 ms (0.00% GC)
  mean time:        4.056 ms (0.00% GC)
  maximum time:     4.761 ms (0.00% GC)
  --------------
  samples:          247
  evals/sample:     1
</code></pre></div></div>

<p>Comparing to C++, <strong>our Julia code is now as fast —and a little
faster—than C++:</strong></p>

<p><strong>In [52]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">true</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_FINAL            is  1.12 times faster than                  C++ (3.552ms vs 3.996ms)
</code></pre></div></div>

<p>However, our Julia code is using clang’s fastmath compilation mode. A more fair
comparison is done by also compiling C++ with the <code class="highlighter-rouge">-ffast-math</code> flag in addition
to <code class="highlighter-rouge">-O3</code>, which I have coded, compiled, and wrapped in this
<a href="https://github.com/JuliaInterop/CxxWrap.jl">CxxWrap</a>:</p>

<p><strong>In [34]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Run C++ benchmark with -ffast-math flag</span>
<span class="n">cpptime</span> <span class="o">=</span> <span class="n">CxxVortexTestFASTMATH</span><span class="o">.</span><span class="n">benchmarkP2P_wrap</span><span class="x">(</span><span class="n">ntests</span><span class="x">,</span> <span class="n">n</span><span class="x">,</span> <span class="kt">Float32</span><span class="x">(</span><span class="n">lambda</span><span class="x">),</span> <span class="n">verbose</span><span class="x">)</span>

<span class="c"># Store benchmark result</span>
<span class="n">benchtime</span><span class="x">[</span><span class="s">"C++ -ffast-math"</span><span class="x">]</span> <span class="o">=</span> <span class="n">cpptime</span><span class="x">;</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Samples:	1000
min time:	1.40114 ms
ave time:	1.72617 ms
max time:	2.71737 ms
</code></pre></div></div>

<p><strong>In [53]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++ -ffast-math"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++ -ffast-math      is  2.54 times faster than            P2P_FINAL (1.401ms vs 3.552ms)
</code></pre></div></div>

<p>And once again, <code class="highlighter-rouge">-ffast-math</code> places C++ at a modest 2.5x over the optimized
Julia code; but be not discouraged, we are talking about a dynamic-like language
that is <strong>only 0.4x slower than C++</strong>! =]</p>

<p><strong>NOTE:</strong> In a subsequent test I commented out the two power operations (<code class="highlighter-rouge">r =
sqrt(...)</code> and <code class="highlighter-rouge">gsgm, dgsgmdr = g_dgdr(r/Pj.sigma)</code>) and the resulting wall-
clock time went down from 6.35ms to 0.496ms, meaning that at this stage the
overhead is on non-algebraic operations and that the function could further be
optimized only by finding a more efficient way of calculation powers in Julia.</p>

<h2 id="julia-as-fast-as-c">Julia as Fast as C++</h2>

<p>Finally, let’s take a second to compare where we started and where we ended. Our
initial Julia function was very compact and understandable, however it was more
than 50x slower than its C++ counterpart:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="s">"""
    Pythonic programming approach
"""</span>
<span class="k">function</span><span class="nf"> P2P_pythonic</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>

            <span class="n">dX</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">dX</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss</span> <span class="o">=</span> <span class="n">cross</span><span class="x">(</span><span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="x">(</span><span class="n">dX</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">),</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="o">:</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
                    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="n">const4</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">)</span> <span class="o">*</span> <span class="n">cross</span><span class="x">([</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="x">],</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span> <span class="x">)</span>
                <span class="k">end</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p><strong>In [48]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_pythonic</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is 58.48 times faster than         P2P_pythonic (3.996ms vs 233.679ms)
</code></pre></div></div>

<p>After all the optimization we end up with about twice the amount of lines, but
65x faster that the original version and only 2.5x slower than C++ with
<code class="highlighter-rouge">-ffastmath</code>:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
    Optimized Julia code
"""</span>
<span class="k">function</span><span class="nf"> P2P_FINAL</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span><span class="x">)</span>

    <span class="k">for</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="n">Pi</span><span class="x">)</span> <span class="k">in</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">particles</span><span class="x">)</span>
        <span class="nd">@simd</span> <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>

            <span class="nd">@fastmath</span> <span class="nd">@inbounds</span> <span class="k">begin</span>
                <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X1</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X1</span>
                <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X2</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X2</span>
                <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X3</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X3</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

                <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                    <span class="c"># g_σ and ∂gσ∂r</span>
                    <span class="n">gsgm</span><span class="x">,</span> <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">g_dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                    <span class="c"># K × Γp</span>
                    <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="x">)</span>
                    <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="x">)</span>
                    <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="x">)</span>

                    <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                    <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                    <span class="c"># Adds the Kronecker delta term</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>

                <span class="k">end</span>
            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p><strong>In [54]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="n">P2P_pythonic</span><span class="x">,</span> <span class="nb">true</span><span class="x">)</span>
<span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">true</span><span class="x">)</span>
<span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++ -ffast-math"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_FINAL            is 65.79 times faster than         P2P_pythonic (3.552ms vs 233.679ms)
P2P_FINAL            is  1.12 times faster than                  C++ (3.552ms vs 3.996ms)
C++ -ffast-math      is  2.54 times faster than            P2P_FINAL (1.401ms vs 3.552ms)
</code></pre></div></div>

<p>Oddly enough, through the optimization process we naturally morphed the code
into something that looks very similar to the C++ version:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Particle-to-particle interactions</span>
<span class="kt">void</span> <span class="nf">P2P</span><span class="p">(</span><span class="n">Particle</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">numParticles</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">real_t</span> <span class="n">r</span><span class="p">,</span> <span class="n">ros</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">g_sgm</span><span class="p">,</span> <span class="n">dgdr</span><span class="p">;</span>
  <span class="n">vec3</span> <span class="n">dX</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
          <span class="n">ros</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="p">;</span>

          <span class="c1">// Evaluate g_σ and ∂gσ∂r</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span>
          <span class="n">g_sgm</span> <span class="o">=</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">dgdr</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">/</span> <span class="p">(</span> <span class="n">aux</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">);</span>

          <span class="c1">// u(x) = ∑g_σ(x−xp) K(x−xp) × Γp</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="n">g_sgm</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>

          <span class="c1">// ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp]</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">dgdr</span><span class="o">/</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">g_sgm</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">));</span>
          <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">){</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="c1">// Adds the Kronecker delta term</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span> <span class="n">const4</span> <span class="o">*</span> <span class="n">g_sgm</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">);</span>
          <span class="c1">// k=1</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="c1">// k=2</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="c1">// k=3</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>In conclusion, if you are trying to get a piece of code fit for high-performance
computing, my recommendation is to <strong>forget about elegant and line-efficient
coding (“pythonic” some would say), and code in C++-esque style from the
beginning</strong>.</p>

<h2 id="conclusions">Conclusions</h2>

<ul>
  <li>
    <p>Without foreknowledge of the types to be handled, Julia can’t optimize the
code during compilation. Multiple dispatch and JIT will compile a well-defined
version of every function based on the arguments that is given on the fly, but
this is not the case for structs properties. <strong>Always define your structs with
its <a href="https://docs.julialang.org/en/v1/manual/performance-tips/index.html#Type-
declarations-1">properties explicitely specified as concrete
types</a></strong>.</p>
  </li>
  <li>
    <p><a href="https://docs.julialang.org/en/v1/manual/performance-
tips/index.html#man-code-warntype-1"><code class="highlighter-rouge">@code_warntype</code></a> is your best friend when trying to catch
abstract types in your code.</p>
  </li>
  <li>
    <p><strong>Avoid memory allocation:</strong> If your function is allocating an insane amount
of memory, that’s an indication that you are saving yourself some lines of code
while sacrificing computation efficiency (<em>e.g.,</em> inline list-comprehension
operations or array algebra instead of unrolling the operations
into explicit code). I recommend using
<a href="https://docs.julialang.org/en/v1/manual/performance-tips/index.html
#Measure-performance-with-[@time](@ref)-and-pay-attention-to-memory-
allocation-1"><code class="highlighter-rouge">@time</code></a> or <a href="https://github.com/JuliaCI/BenchmarkTools.jl/blo
b/master/doc/manual.md"><code class="highlighter-rouge">@benchmark</code></a> to check memory allocation.</p>
  </li>
  <li>
    <p><strong>Avoid storing intermediate calculations in internal arrays, just use Float
variables</strong>. For some reason Julia spends a lot of time trying to allocate space
for internal arrays.</p>
  </li>
  <li>
    <p>Any <strong>non-integer power operations (<code class="highlighter-rouge">^</code> or <code class="highlighter-rouge">sqrt</code>) are very expensive</strong> in
Julia. If possible, reduce these operations by storing and reusing previous
calculations.</p>
  </li>
  <li>
    <p>At all cost, <strong>avoid using functions from the LinearAlgebra package</strong>
(like <code class="highlighter-rouge">dot</code>, <code class="highlighter-rouge">cross</code>, <code class="highlighter-rouge">norm</code>) as they will require allocating memory for
internal arrays.</p>
  </li>
  <li>
    <p>For some reason,
<a href="https://docs.julialang.org/en/v1/base/base/#Base.SimdLoop.@simd"><code class="highlighter-rouge">@simd</code></a>,
<a href="https://docs.julialang.org/en/v1/base/math/#Base.FastMath.@fastmath"><code class="highlighter-rouge">@fastmath</code></a>,
and <a href="https://docs.julialang.org/en/v1/base/base/#Base.@inbounds"><code class="highlighter-rouge">@inbounds</code></a>
speed up your code only when working with <code class="highlighter-rouge">isbits</code> types.</p>
  </li>
  <li>
    <p><strong>Forget about elegant and line-efficient coding (“pythonic” some would say),
and code in C++-esque style</strong> in parts of the code where performance is
critical.</p>
  </li>
</ul>

<h3 id="notes">Notes</h3>

<ul>
  <li>This benchmark was done in a Dell Latitude 5580 laptop (Intel® Core™ i7-7820HQ
CPU @ 2.90GHz × 8 ) in only one process.</li>
  <li>Julia v1.0.3 was used.</li>
  <li>The official <a href="https://docs.julialang.org/en/v1/manual
/performance-tips/index.html">Julia documentation</a> also provide very useful tips for performance.</li>
  <li>The code used in this post is available here:
<a href="https://github.com/EdoAlvarezR/post-juliavscpp">https://github.com/EdoAlvarezR/post-juliavscpp</a></li>
</ul>

<h3 id="references">References</h3>

<ol>
  <li>Winckelmans, G. S., &amp; Leonard, A. (1993). Contributions to Vortex Particle
Methods for the Computation of Three-Dimensional Incompressible Unsteady Flows.
Journal of Computational Physics, 109(2), 247–273.
https://doi.org/10.1006/jcph.1993.1216</li>
  <li>Alvarez, E. J., &amp; Ning, A. (2018). Development of a Vortex Particle Code for
the Modeling of Wake Interaction in Distributed Propulsion. In 2018 Applied
Aerodynamics Conference (pp. 1–22). American Institute of Aeronautics and
Astronautics. https://doi.org/10.2514/6.2018-3646 . <a href="https://scholarsarchive.byu.edu/facpub/2116/">PDF
Available</a></li>
</ol>

</div>

<!-- <center>
<img src="/posts/vortex00.gif" alt="Vid here" width="500px" />
</center>

<h2 id="introduction">Introduction</h2>

<p>The rumor says that Julia can achieve the <a href="https://julialang.org/benchmarks/">same computing
performance</a> as any other compiled language
like C++ and FORTRAN. After coding in Julia for the past two years I have
definitely fell in love with its pythonic syntax, multiple dispatch, and MATLAB-like
handiness in linear algebra, while being able to use compilation features
like explicit type declaration for bug-preventive programming. In summary,
Julia’s philosophy brings all the flexibility of an interpreted language,
meanwhile its Just-In-Time (JIT) compilation makes it a defacto
compiled language.</p>

<p>Julia’s high level syntax makes the language easygoing for programmers from any
background, however, achieving high performance is sort of
an art. In this post I summarize some of the things I’ve learned while crafting
my Julia codes for high-performance computing. I will attempt to show the
process of code optimization through a real-world computing application from
aerodynamics: the <a href="https://scholarsarchive.byu.edu/facpub/2116/">vortex particle
method</a><script type="math/tex">^{[1,\,2]}</script>.</p>

<h2 id="problem-definition">Problem Definition</h2>

<p>In the <a href="https://scholarsarchive.byu.edu/facpub/2116/">vortex particle method</a> we
are interested in calculating the velocity <script type="math/tex">\mathbf{u}</script> and velocity Jacobian
<script type="math/tex">\mathbf{J}</script> that a field of <script type="math/tex">N</script> vortex particles induces at an arbitrary
position <script type="math/tex">\mathbf{x}</script>. This is calculated as</p>

<script type="math/tex; mode=display">{\bf u}\left( {\bf x} \right) = \sum\limits_p^N g_\sigma\left(
{\bf x}-{\bf x}_p \right)
                                                {\bf K}\left( {\bf x}-{\bf x}_p
\right)   \times
                                    \boldsymbol\Gamma_p</script>

<script type="math/tex; mode=display">\frac{\partial {\bf u}}{\partial x_j}\left( {\bf x} \right)
        = \sum\limits_p^N \left[
            \left(
                \frac{1}{\sigma }
                 \frac{\Delta x_j}{\Vert \Delta \mathbf{x} \Vert}
                 \frac{\partial g}{\partial r}
                 \left(
                             \frac{\Vert \Delta\mathbf{x} \Vert}{\sigma}
                 \right) -
                 3 g_\sigma\left( \Delta{\bf x} \right)
                 \frac{\Delta x_j}{\Vert \Delta\mathbf{x} \Vert^2}
            \right)
            {\bf K}\left( \Delta\mathbf{x} \right)  \times \boldsymbol\Gamma_p -
            \frac{g_\sigma\left( \Delta{\bf x} \right) }{4\pi \Vert \Delta{\bf
x} \Vert^3}
            \delta_{ij} \times \boldsymbol\Gamma_p
        \right]
,</script>

<p>with <script type="math/tex">{\bf K}</script> the singular Newtonian kernel <script type="math/tex">{\bf K}\left( {\bf x}\right)=-\frac{ {\bf x} }{4\pi \Vert{\bf x}\Vert^3}</script>, <script type="math/tex">g_\sigma</script> a regularizing
function of smoothing radius <script type="math/tex">\sigma</script>, and <script type="math/tex">\mathbf{x}_p</script> and
<script type="math/tex">\boldsymbol{\Gamma}_p</script> the position and vectorial strength of the <script type="math/tex">p</script>-th
particle, respectively. Furthermore, the governing equations of the method
require evaluating the velocity <script type="math/tex">\mathbf{u}</script> and Jacobian <script type="math/tex">\mathbf{J}</script> that the
collection of particles induces on itself, leading to the well-known <a href="https://en.wikipedia.org/wiki/N-body_problem"><script type="math/tex">N</script>-body
problem</a> of computational
complexity <script type="math/tex">\mathcal{O}(N^2)</script>.</p>

<p>Choosing Winckelmans’ regularizing kernel<script type="math/tex">^{[1]}</script></p>

<script type="math/tex; mode=display">g(r) = r^3 \frac{r^2 + 5/2}{\left( r^2 + 1 \right)^{5/2}}</script>

<script type="math/tex; mode=display">\frac{\partial g}{\partial r} (r) = \frac{15}{2}
            \frac{r^2}{\left( r^2 + 1 \right)^{7/2}}
,</script>

<p>the above equations are implemented in C++ as follows:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Particle-to-particle interactions</span>
<span class="kt">void</span> <span class="nf">P2P</span><span class="p">(</span><span class="n">Particle</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">numParticles</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">real_t</span> <span class="n">r</span><span class="p">,</span> <span class="n">ros</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">g_sgm</span><span class="p">,</span> <span class="n">dgdr</span><span class="p">;</span>
  <span class="n">vec3</span> <span class="n">dX</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
          <span class="n">ros</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="p">;</span>

          <span class="c1">// Evaluate g_σ and ∂gσ∂r</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span>
          <span class="n">g_sgm</span> <span class="o">=</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">dgdr</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">/</span> <span class="p">(</span> <span class="n">aux</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">);</span>

          <span class="c1">// u(x) = ∑g_σ(x−xp) K(x−xp) × Γp</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="n">g_sgm</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>

          <span class="c1">// ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp]</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">dgdr</span><span class="o">/</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">g_sgm</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">));</span>
          <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">){</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="c1">// Adds the Kronecker delta term</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span> <span class="n">const4</span> <span class="o">*</span> <span class="n">g_sgm</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">);</span>
          <span class="c1">// k=1</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="c1">// k=2</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="c1">// k=3</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>The figure at the top of the page is a simulation of a 6x6x6 box of particles with vorticity
initially concentrated at its center, diffusing as the simulation progresses due
to viscous effects:
<!-- <center>
<img src="vortex00.gif" alt="Vid here" width="500px">
</center> --></p>

<h2 id="c-benchmark">C++ Benchmark</h2>

<p>Here I have <a href="https://github.com/EdoAlvarezR/post-juliavscpp">coded a benchmark</a>
of the C++ code shown above, evaluating <code class="highlighter-rouge">P2P</code> on a box of 6x6x6=216 particles,
and made it callable in this notebook through the
<a href="https://github.com/JuliaInterop/CxxWrap.jl">CxxWrap</a> Julia package:</p>

<p><strong>In [1]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="cm">#=
    This cell loads auxiliary benchmarking functions available
    here: https://github.com/EdoAlvarezR/post-juliavscpp
=#</span>

<span class="k">using</span> <span class="n">LinearAlgebra</span>

<span class="c"># Load C++ code wrapped as module CxxVortexTest</span>
<span class="n">include</span><span class="x">(</span><span class="s">"code/vortextest.jl"</span><span class="x">)</span>

<span class="c"># Load benchmarking tools</span>
<span class="n">include</span><span class="x">(</span><span class="s">"code/benchmarking.jl"</span><span class="x">);</span></code></pre></figure>

<p><strong>In [2]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">ntests</span> <span class="o">=</span> <span class="mi">1000</span>               <span class="c"># Tests to run</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>                       <span class="c"># Particles per side</span>
<span class="n">lambda</span> <span class="o">=</span> <span class="mf">1.5</span>                <span class="c"># Core overlap</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="nb">true</span>

<span class="c"># Run C++ benchmark</span>
<span class="n">cpptime</span> <span class="o">=</span> <span class="n">CxxVortexTest</span><span class="o">.</span><span class="n">benchmarkP2P_wrap</span><span class="x">(</span><span class="n">ntests</span><span class="x">,</span> <span class="n">n</span><span class="x">,</span> <span class="kt">Float32</span><span class="x">(</span><span class="n">lambda</span><span class="x">),</span> <span class="n">verbose</span><span class="x">)</span>

<span class="c"># Store benchmark result</span>
<span class="n">benchtime</span><span class="x">[</span><span class="s">"C++"</span><span class="x">]</span> <span class="o">=</span> <span class="n">cpptime</span><span class="x">;</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Samples:	1000
min time:	3.99555 ms
ave time:	4.77778 ms
max time:	6.73414 ms
</code></pre></div></div>

<p>This was ran in my Dell Latitude 5580 laptop (Intel® Core™ i7-7820HQ CPU @
2.90GHz × 8 ) in only one process, and we see that <strong>the C++ kernel, best-case
scenario, is evaluated in ~4 ms</strong>. Let’s move on and code this up in Julia.</p>

<p><strong>NOTE:</strong> The C++ code was compiled with the <code class="highlighter-rouge">-O3</code> flag for code optimization.</p>

<h2 id="optimizing-julia">Optimizing Julia</h2>

<h3 id="julia-baseline-pythonic-programming">Julia Baseline: Pythonic Programming</h3>

<p>Tempted by the Python-like syntax available in Julia, our first inclination is
to make the code as general, simple, and easy to understand as possible. Here is
the most general implementation where no types are specified:</p>

<p><strong>In [3]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
This is a particle struct made up of ambiguous (unspecified) types
"""</span>
<span class="k">struct</span> <span class="n">ParticleAmbiguous</span>

    <span class="c"># User inputs</span>
    <span class="n">X</span>                               <span class="c"># Position</span>
    <span class="n">Gamma</span>                           <span class="c"># Vectorial circulation</span>
    <span class="n">sigma</span>                           <span class="c"># Smoothing radius</span>

    <span class="c"># Properties</span>
    <span class="n">U</span>                               <span class="c"># Velocity at particle</span>
    <span class="n">J</span>                               <span class="c"># Jacobian at particle J[i,j]=dUi/dxj</span>

    <span class="n">ParticleAmbiguous</span><span class="x">(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">;</span> <span class="n">U</span><span class="o">=</span><span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">),</span> <span class="n">J</span><span class="o">=</span><span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">,</span><span class="mi">3</span><span class="x">)</span>
                      <span class="x">)</span> <span class="o">=</span> <span class="n">new</span><span class="x">(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span> <span class="x">)</span>
<span class="k">end</span>

<span class="c"># Empty initializer</span>
<span class="n">Base</span><span class="o">.</span><span class="n">zero</span><span class="x">(</span><span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="o">&lt;:</span><span class="n">ParticleAmbiguous</span><span class="x">})</span> <span class="o">=</span> <span class="n">ParticleAmbiguous</span><span class="x">(</span><span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="mi">3</span><span class="x">),</span> <span class="mf">0.0</span><span class="x">)</span>




<span class="c"># Winckelmans regularizing kernel</span>
<span class="n">g_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.5</span><span class="x">)</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">2.5</span>
<span class="n">dgdr_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">3.5</span>

<span class="kd">const</span> <span class="n">const4</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="x">(</span><span class="mi">4</span><span class="o">*</span><span class="nb">pi</span><span class="x">)</span>




<span class="s">"""
    Pythonic programming approach
"""</span>
<span class="k">function</span><span class="nf"> P2P_pythonic</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">dX</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss</span> <span class="o">=</span> <span class="n">cross</span><span class="x">(</span><span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="x">(</span><span class="n">dX</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">),</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="o">:</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
                    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="n">const4</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">)</span> <span class="o">*</span> <span class="n">cross</span><span class="x">([</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="x">],</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span> <span class="x">)</span>
                <span class="k">end</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [4]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Create a 6x6x6 box of ambiguous particles</span>
<span class="n">particles_amb</span> <span class="o">=</span> <span class="n">generate_particles</span><span class="x">(</span><span class="n">ParticleAmbiguous</span><span class="x">,</span> <span class="n">n</span><span class="x">,</span> <span class="n">lambda</span><span class="x">)</span>

<span class="c"># Run benchmark</span>
<span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles_amb</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_pythonic</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="n">args</span><span class="x">;</span> <span class="n">reverse</span><span class="o">=</span><span class="nb">false</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_pythonic</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is 58.48 times faster than         P2P_pythonic (3.996ms vs 233.679ms)

BenchmarkTools.Trial:
  memory estimate:  217.57 MiB
  allocs estimate:  4087152
  --------------
  minimum time:     233.679 ms (5.04% GC)
  median time:      238.482 ms (4.99% GC)
  mean time:        251.540 ms (9.28% GC)
  maximum time:     295.517 ms (19.89% GC)
  --------------
  samples:          4
  evals/sample:     1
</code></pre></div></div>

<p>Here we see that in our pythonic attempt we’ve got code that is <strong>pretty neat
and concise, but ~58x slower than the C++ implementation</strong>.</p>

<h3 id="fix-1-always-work-with-concrete-types">Fix #1: Always work with concrete types</h3>

<p>The problem with the pythonic approach is that variable types are never
declared, and <strong>without foreknowledge of the types to be handled, Julia can’t
optimize the function during compilation</strong>. In order to help us catch ambiguous
(abstract) types in our code, the Julia <code class="highlighter-rouge">Base</code> package provides the macro
<code class="highlighter-rouge">@code_warntype</code>, which prints the lowered and type-inferred AST used during
compilation highlighting any abstract types encountered.</p>

<p>The output is pretty lengthy, so here I have copied and pasted only a snippet:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@code_warntype</span> <span class="n">P2P_pythonic</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">)</span>

<span class="n">Body</span><span class="o">::</span><span class="kt">Nothing</span>
<span class="n">│╻╷╷</span>  <span class="n">iterate34</span> <span class="mi">1</span> <span class="n">──</span> <span class="o">%</span><span class="mi">1</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">arraylen</span><span class="x">)(</span><span class="n">particles</span><span class="x">)</span><span class="o">::</span><span class="kt">Int64</span>
<span class="n">││╻╷</span>   <span class="n">iterate</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">2</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">sle_int</span><span class="x">)(</span><span class="mi">0</span><span class="x">,</span> <span class="o">%</span><span class="mi">1</span><span class="x">)</span><span class="o">::</span><span class="kt">Bool</span>
<span class="n">│││╻</span>    <span class="o">&lt;</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">3</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">bitcast</span><span class="x">)(</span><span class="kt">UInt64</span><span class="x">,</span> <span class="o">%</span><span class="mi">1</span><span class="x">)</span><span class="o">::</span><span class="kt">UInt64</span>
<span class="n">││││╻</span>    <span class="o">&lt;</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">4</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">ult_int</span><span class="x">)(</span><span class="mh">0x0000000000000000</span><span class="x">,</span> <span class="o">%</span><span class="mi">3</span><span class="x">)</span><span class="o">::</span><span class="kt">Bool</span>
<span class="n">││││╻</span>    <span class="o">&amp;</span>   <span class="n">│</span>    <span class="o">%</span><span class="mi">5</span>   <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">and_int</span><span class="x">)(</span><span class="o">%</span><span class="mi">2</span><span class="x">,</span> <span class="o">%</span><span class="mi">4</span><span class="x">)</span><span class="o">::</span><span class="kt">Bool</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
<span class="n">│</span>       <span class="mi">11</span> <span class="n">┄</span> <span class="o">%</span><span class="mi">33</span>  <span class="o">=</span> <span class="n">φ</span> <span class="x">(</span><span class="c">#10 =&gt; %28, #34 =&gt; %149)::ParticleAmbiguous</span>
<span class="n">│</span>       <span class="n">│</span>    <span class="o">%</span><span class="mi">34</span>  <span class="o">=</span> <span class="n">φ</span> <span class="x">(</span><span class="c">#10 =&gt; %29, #34 =&gt; %150)::Int64</span>
<span class="n">│╻</span>    <span class="n">getproperty37</span> <span class="n">│</span>    <span class="o">%</span><span class="mi">35</span>  <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">getfield</span><span class="x">)(</span><span class="o">%</span><span class="mi">16</span><span class="x">,</span> <span class="o">:</span><span class="n">X</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
<span class="n">││</span>      <span class="n">│</span>    <span class="o">%</span><span class="mi">36</span>  <span class="o">=</span> <span class="x">(</span><span class="n">Base</span><span class="o">.</span><span class="n">getfield</span><span class="x">)(</span><span class="o">%</span><span class="mi">33</span><span class="x">,</span> <span class="o">:</span><span class="n">X</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
<span class="n">│</span>       <span class="n">│</span>    <span class="o">%</span><span class="mi">37</span>  <span class="o">=</span> <span class="x">(</span><span class="o">%</span><span class="mi">35</span> <span class="o">-</span> <span class="o">%</span><span class="mi">36</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
<span class="n">│</span>    <span class="mi">38</span> <span class="n">│</span>    <span class="o">%</span><span class="mi">38</span>  <span class="o">=</span> <span class="x">(</span><span class="n">Main</span><span class="o">.</span><span class="n">norm</span><span class="x">)(</span><span class="o">%</span><span class="mi">37</span><span class="x">)</span><span class="o">::</span><span class="kt">Any</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
</code></pre></div></div>

<p>Understanding this lowered AST syntax is sort of an art, but you’ll soon learn
that <code class="highlighter-rouge">@code_warntype</code> is your best friend when optimizing code. As we scroll
down the AST we see that code encounters types <code class="highlighter-rouge">Any</code> in the properties of our
<code class="highlighter-rouge">ParticleAmbiguous</code> type, which immediately should raise a red flag to us (<code class="highlighter-rouge">Any</code>
is an abstract type). In fact, when running <code class="highlighter-rouge">@code_warntype</code> the output
automatically highlights those <code class="highlighter-rouge">::Any</code> asserts in red.</p>

<p>We can take care of those abstract types by defining the properties of the
<a href="https://docs.julialang.org/en/v1/manual/performance-
tips/index.html#Type-declarations-1">struct parametrically</a>:</p>

<p><strong>In [5]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
This is a particle struct with property types
explicitely/parametrically defined.
"""</span>
<span class="k">struct</span> <span class="n">Particle</span><span class="x">{</span><span class="n">T</span><span class="x">}</span>

  <span class="c"># User inputs</span>
  <span class="n">X</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">1</span><span class="x">}</span>                <span class="c"># Position</span>
  <span class="n">Gamma</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">1</span><span class="x">}</span>            <span class="c"># Vectorial circulation</span>
  <span class="n">sigma</span><span class="o">::</span><span class="n">T</span>                      <span class="c"># Smoothing radius</span>

  <span class="c"># Properties</span>
  <span class="n">U</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">1</span><span class="x">}</span>                <span class="c"># Velocity at particle</span>
  <span class="n">J</span><span class="o">::</span><span class="kt">Array</span><span class="x">{</span><span class="n">T</span><span class="x">,</span> <span class="mi">2</span><span class="x">}</span>                <span class="c"># Jacobian at particle J[i,j]=dUi/dxj</span>

<span class="k">end</span>

<span class="c"># Another initializer alias</span>
<span class="n">Particle</span><span class="x">{</span><span class="n">T</span><span class="x">}(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">)</span> <span class="n">where</span> <span class="x">{</span><span class="n">T</span><span class="x">}</span> <span class="o">=</span> <span class="n">Particle</span><span class="x">(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">,</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span><span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">))</span>

<span class="c"># Empty initializer</span>
<span class="n">Base</span><span class="o">.</span><span class="n">zero</span><span class="x">(</span><span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="o">&lt;:</span><span class="n">Particle</span><span class="x">{</span><span class="n">T</span><span class="x">}})</span> <span class="n">where</span> <span class="x">{</span><span class="n">T</span><span class="x">}</span> <span class="o">=</span> <span class="n">Particle</span><span class="x">(</span><span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">),</span>
                                                      <span class="n">zero</span><span class="x">(</span><span class="n">T</span><span class="x">),</span>
                                                      <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">),</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">))</span></code></pre></figure>

<p>No modifications further are needed in our <code class="highlighter-rouge">P2P_pythonic</code> function since Julia’s
multiple dispatch and JIT automatically compiles a version of the function
specialized for our new <code class="highlighter-rouge">Particle{T}</code> type on the fly. Still, we will define an
alias to help us compare benchmarks:</p>

<p><strong>In [6]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">P2P_concretetypes</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">)</span> <span class="o">=</span> <span class="n">P2P_pythonic</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">)</span></code></pre></figure>

<p><strong>In [7]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Create a 6x6x6 box of concrete Float64 particles</span>
<span class="n">particles</span> <span class="o">=</span> <span class="n">generate_particles</span><span class="x">(</span><span class="n">Particle</span><span class="x">{</span><span class="kt">Float64</span><span class="x">},</span> <span class="n">n</span><span class="x">,</span> <span class="n">lambda</span><span class="x">)</span>

<span class="c"># Run benchmark</span>
<span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_concretetypes</span><span class="x">,</span> <span class="n">P2P_pythonic</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_concretetypes</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_concretetypes    is  3.06 times faster than         P2P_pythonic (76.488ms vs 233.679ms)

BenchmarkTools.Trial:
  memory estimate:  189.93 MiB
  allocs estimate:  2275776
  --------------
  minimum time:     76.488 ms (13.63% GC)
  median time:      77.860 ms (13.79% GC)
  mean time:        84.567 ms (17.89% GC)
  maximum time:     145.918 ms (42.64% GC)
  --------------
  samples:          12
  evals/sample:     1
</code></pre></div></div>

<p>Voilà! By specifying concrete types in our <code class="highlighter-rouge">Particle</code> struct now we have gained
a 3x speed up (we should run <code class="highlighter-rouge">@code_warntype</code> again to make sure we got rid of
all abstract types, but I’ll omit it for brevity).</p>

<p>Let’s new see how we compare to C++:</p>

<p><strong>In [8]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_concretetypes</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is 19.14 times faster than    P2P_concretetypes (3.996ms vs 76.488ms)
</code></pre></div></div>

<p>Working with concrete types greatly sped up the computation; however, the C++
version is still ~20x faster than Julia. Let’s see what else can we optimize.</p>

<h3 id="fix-2-avoid-list-comprehensions">Fix #2: Avoid List Comprehensions</h3>

<p>The wonders of list comprehension may tempt you to write some line-efficient
code; however, loosely used may lead to a very inefficient
computation. Take for example this list-comprehension sum:</p>

<p><strong>In [9]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">sum_list</span><span class="x">(</span><span class="n">n</span><span class="x">)</span> <span class="o">=</span> <span class="n">sum</span><span class="x">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="x">])</span>

<span class="nd">@btime</span> <span class="n">sum_list</span><span class="x">(</span><span class="mi">100</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  80.975 ns (1 allocation: 896 bytes)
</code></pre></div></div>

<p>Here is the version of the same function unrolled without the list
comprehension, which does the job 60 times faster:</p>

<p><strong>In [10]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> sum_unrolled</span><span class="x">(</span><span class="n">n</span><span class="x">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">out</span>
<span class="k">end</span>

<span class="nd">@btime</span> <span class="n">sum_unrolled</span><span class="x">(</span><span class="mi">100</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1.374 ns (0 allocations: 0 bytes)
</code></pre></div></div>

<p>In our P2P function we have a Kronecker delta cross product that we were
calculating in just one line as a list comprehension as</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
        <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                          <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="o">-</span>
                          <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="n">const4</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">)</span> <span class="o">*</span> <span class="n">cross</span><span class="x">([</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="x">],</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span> <span class="x">)</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>The alternative is to expand it into a few lines as</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
        <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                          <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="x">)</span>
    <span class="k">end</span>

    <span class="c"># ∂u∂xj(x) = −∑gσ/(4πr^3) δij×Γp</span>
    <span class="c"># Adds the Kronecker delta term</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
    <span class="c"># j=1</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
    <span class="c"># j=2</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
    <span class="c"># j=3</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
</code></pre></div></div>

<p>The problem with list comprehension operations is that it has to allocate memory
to build the generated array. Just resist the temptation of using list
comprehensions to save yourself a few lines, and simply unroll it. As seen below
we get a 1.5x speed up by unrolling this line:</p>

<p><strong>In [11]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    Unrolling the list comprehension
"""</span>
<span class="k">function</span><span class="nf"> P2P_nocomprehension</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">dX</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss</span> <span class="o">=</span> <span class="n">cross</span><span class="x">(</span><span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="x">(</span><span class="n">dX</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">),</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="o">:</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
                    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="x">)</span>
                <span class="k">end</span>

                <span class="c"># ∂u∂xj(x) += −∑gσ/(4πr^3) δij×Γp</span>
                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [12]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_nocomprehension</span><span class="x">,</span> <span class="n">P2P_concretetypes</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_nocomprehension</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_nocomprehension  is  1.52 times faster than    P2P_concretetypes (50.196ms vs 76.488ms)

BenchmarkTools.Trial:
  memory estimate:  126.16 MiB
  allocs estimate:  1300536
  --------------
  minimum time:     50.196 ms (11.28% GC)
  median time:      51.929 ms (11.65% GC)
  mean time:        55.319 ms (15.41% GC)
  maximum time:     107.039 ms (50.23% GC)
  --------------
  samples:          19
  evals/sample:     1
</code></pre></div></div>

<h3 id="fix-3-reduce-allocation">Fix #3: Reduce Allocation</h3>

<p>Next, we notice that the benchmarking test is allotting an unusual amount of
memory (126MiB) and allocation operations (1.3M). I am suspicious that this is
an issue with Julia allowing arrays of dynamic sizes. The first step to solve
this is to <strong>do away with creating any internal variables of type arrays</strong>. In
the code bellow, notice that I had replaced the array variables <code class="highlighter-rouge">dX</code> and <code class="highlighter-rouge">crss</code>
with float variables <code class="highlighter-rouge">dX1, dX2, dX3</code>, and <code class="highlighter-rouge">crss1, crss2, crss3</code>, which leads to
having to fully unroll the inner for-loop:</p>

<p><strong>In [13]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    Reducing memory allocation
"""</span>
<span class="k">function</span><span class="nf"> P2P_noallocation</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
            <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
            <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss1</span><span class="x">,</span> <span class="n">crss2</span><span class="x">,</span> <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cross</span><span class="x">(</span><span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">,</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [14]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_noallocation</span><span class="x">,</span> <span class="n">P2P_nocomprehension</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_noallocation</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_noallocation     is  3.68 times faster than  P2P_nocomprehension (13.627ms vs 50.196ms)

BenchmarkTools.Trial:
  memory estimate:  21.99 MiB
  allocs estimate:  325296
  --------------
  minimum time:     13.627 ms (7.41% GC)
  median time:      15.615 ms (8.40% GC)
  mean time:        16.582 ms (12.83% GC)
  maximum time:     59.011 ms (66.91% GC)
  --------------
  samples:          61
  evals/sample:     1
</code></pre></div></div>

<p>Here we have reduced the memory allocated from 126MiB to 22MiB, leading to a
3.5x speed up. Let’s see what else can we do to decrease memory allocation.</p>

<h3 id="fix-4-no-linear-algebra">Fix #4: No Linear Algebra</h3>

<p>The next thing to consider is that doing <strong>linear algebra operations
using the Julia base library (i.e., <code class="highlighter-rouge">dot(X,X)</code>,
<code class="highlighter-rouge">cross(X,X)</code>, <code class="highlighter-rouge">norm(X,X)</code>) is more expensive that explicitely unfolding the
operation into lines of code</strong>. I am suspicious that this is a memory allocation
problem since these functions need to allocate internal arrays to store the
computation prior to outputting the result. Here is the code without any
functional linear algebra functions from the base library (notice that I no longer use <code class="highlighter-rouge">norm()</code> nor
<code class="highlighter-rouge">cross()</code>):</p>

<p><strong>In [15]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    No linear algebra functions
"""</span>
<span class="k">function</span><span class="nf"> P2P_nolinalg</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
            <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
            <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [16]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_wnk</span><span class="x">,</span> <span class="n">dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_nolinalg</span><span class="x">,</span> <span class="n">P2P_noallocation</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_nolinalg</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_nolinalg         is  2.10 times faster than     P2P_noallocation (6.487ms vs 13.627ms)

BenchmarkTools.Trial:
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     6.487 ms (0.00% GC)
  median time:      7.140 ms (0.00% GC)
  mean time:        7.198 ms (0.00% GC)
  maximum time:     9.172 ms (0.00% GC)
  --------------
  samples:          139
  evals/sample:     1
</code></pre></div></div>

<p>By doing away with linear algebra functions we are now <strong>not allocating any
memory, reaching an extra 2x speed up</strong>.</p>

<h3 id="fix-5-fine-tuning">Fix #5: Fine Tuning</h3>

<p>Notice that by now we are achieving benchmarks in the same order of magnitude
than C++ (6.5ms in Julia vs 4.0ms in C++):</p>

<p><strong>In [17]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_nolinalg</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is  1.62 times faster than         P2P_nolinalg (3.996ms vs 6.487ms)
</code></pre></div></div>

<p>What we did prior to this point were
general principles that apply to any code that attempts to get high performance.
What it follows now is fine tuning of our code in ways that only apply to the
specific computation that we are performing.</p>

<p>For instance, recall that our P2P function receives any user-defined
regularizing kernel that our function calls through this lines:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="nf"> P2P</span><span class="x">(</span><span class="n">sources</span><span class="x">,</span> <span class="n">targets</span><span class="x">,</span> <span class="n">g</span><span class="o">::</span><span class="n">Function</span><span class="x">,</span> <span class="n">dgdr</span><span class="o">::</span><span class="n">Function</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">targets</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">sources</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="c"># g_σ and ∂gσ∂r</span>
            <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
            <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
            <span class="o">.</span>
            <span class="o">.</span>
            <span class="o">.</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For the case of Winckelmans’ kernel, <code class="highlighter-rouge">g</code> and <code class="highlighter-rouge">dgdr</code> look like this:</p>
<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">g_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.5</span><span class="x">)</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">2.5</span>
<span class="n">dgdr_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">/</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">3.5</span>
</code></pre></div></div>

<p>We notice that each of these function calculate a power operation independently,
<code class="highlighter-rouge">(r^2 + 1)^2.5</code> and <code class="highlighter-rouge">(r^2 + 1)^3.5</code>. I have observed that <strong>any sort of non-integer
power operation takes Julia more than any basic arithmetic operation or
even space allocation</strong>. Thus, we can save computation by merging this two functions
and reusing the square root calculation as</p>

<p><strong>In [45]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">function</span><span class="nf"> g_dgdr_wnk</span><span class="x">(</span><span class="n">r</span><span class="x">)</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">^</span><span class="mf">2.5</span>

    <span class="c"># Returns g and dgdr</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="o">*</span><span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">2.5</span><span class="x">)</span><span class="o">/</span><span class="n">aux</span><span class="x">,</span> <span class="mf">7.5</span><span class="o">*</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="o">/</span><span class="x">(</span><span class="n">aux</span><span class="o">*</span><span class="x">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="x">))</span>
<span class="k">end</span>

<span class="s">"""
    Reuses sqrt, reducing to only one power calculation
"""</span>
<span class="k">function</span><span class="nf"> P2P_reusesqrt</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>    

            <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
            <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
            <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span><span class="x">,</span> <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">g_dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="x">)</span>
                <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                <span class="c"># Adds the Kronecker delta term</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                <span class="c"># j=1</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="c"># j=2</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">3</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
                <span class="c"># j=3</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">2</span><span class="x">]</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [19]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr_wnk</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_reusesqrt</span><span class="x">,</span> <span class="n">P2P_nolinalg</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_reusesqrt</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_reusesqrt        is  1.60 times faster than         P2P_nolinalg (4.050ms vs 6.487ms)

BenchmarkTools.Trial:
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     4.050 ms (0.00% GC)
  median time:      4.479 ms (0.00% GC)
  mean time:        4.493 ms (0.00% GC)
  maximum time:     5.361 ms (0.00% GC)
  --------------
  samples:          223
  evals/sample:     1
</code></pre></div></div>

<p>Hence, by <strong>simply avoiding one extra power calculation we have now gained a
1.6x speed up.</strong></p>

<h3 id="final-fix-inbounds-simd-fastmath">Final Fix: <code class="highlighter-rouge">@inbounds</code>, <code class="highlighter-rouge">@simd</code>, <code class="highlighter-rouge">@fastmath</code></h3>

<p>This is straight from the Julia official documentation:</p>

<p><a href="https://docs.julialang.org/en/v1/devdocs/boundscheck/index.html"><code class="highlighter-rouge">@inbounds</code></a></p>
<blockquote>
  <p>Like many modern programming languages, Julia uses bounds checking to ensure
program safety when accessing arrays. In tight inner loops or other performance
critical situations, you may wish to skip these bounds checks to improve runtime
performance. For instance, in order to emit vectorized (SIMD) instructions, your
loop body cannot contain branches, and thus cannot contain bounds checks.
Consequently, Julia includes an @inbounds(…) macro to tell the compiler to
skip such bounds checks within the given block. User-defined array types can use
the @boundscheck(…) macro to achieve context-sensitive code selection.</p>
</blockquote>

<p><a href="https://docs.julialang.org/en/v1/manual/performance-tips/index.html
#man-performance-annotations-1"><code class="highlighter-rouge">@simd</code></a></p>
<blockquote>
  <p>Write @simd in front of for loops to promise that the iterations are
independent and may be reordered. Note that in many cases, Julia can
automatically vectorize code without the @simd macro; it is only beneficial in
cases where such a transformation would otherwise be illegal, including cases
like allowing floating-point re-associativity and ignoring dependent memory
accesses (@simd ivdep). Again, be very careful when asserting @simd as
erroneously annotating a loop with dependent iterations may result in unexpected
results. In particular, note that setindex! on some AbstractArray subtypes is
inherently dependent upon iteration order. This feature is experimental and
could change or disappear in future versions of Julia.</p>
</blockquote>

<p><a href="https://docs.julialang.org/en/v1/manual/performance-
tips/index.html#man-performance-annotations-1"><code class="highlighter-rouge">@fastmath</code></a></p>
<blockquote>
  <p>Use @fastmath to allow floating point optimizations that are correct for real
numbers, but lead to differences for IEEE numbers. Be careful when doing this,
as this may change numerical results. This corresponds to the -ffast-math option
of clang.</p>
</blockquote>

<p>I won’t dive into details, but what I have realized is that you can get a speed
up from the three macros listed above only when you are working with <a href="https://docs.julialang.org/en/v1/devdocs/isbitsunionarrays/">data
structures that pass the <code class="highlighter-rouge">isbits</code>
test</a>. In practice,
that means that our structs can’t contain any arrays, which lead us to
redefining the struct as follows:</p>

<p><strong>In [30]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="k">struct</span> <span class="n">ParticleNoArr</span><span class="x">{</span><span class="n">T</span><span class="x">}</span>

  <span class="c"># User inputs</span>
  <span class="n">X1</span><span class="o">::</span><span class="n">T</span>
  <span class="n">X2</span><span class="o">::</span><span class="n">T</span>
  <span class="n">X3</span><span class="o">::</span><span class="n">T</span>
  <span class="n">Gamma1</span><span class="o">::</span><span class="n">T</span>
  <span class="n">Gamma2</span><span class="o">::</span><span class="n">T</span>
  <span class="n">Gamma3</span><span class="o">::</span><span class="n">T</span>
  <span class="n">sigma</span><span class="o">::</span><span class="n">T</span>

<span class="k">end</span>

<span class="c"># Empty initializer</span>
<span class="n">Base</span><span class="o">.</span><span class="n">zero</span><span class="x">(</span><span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="o">&lt;:</span><span class="n">ParticleNoArr</span><span class="x">{</span><span class="n">T</span><span class="x">}})</span> <span class="n">where</span> <span class="x">{</span><span class="n">T</span><span class="x">}</span> <span class="o">=</span> <span class="n">ParticleNoArr</span><span class="x">(</span><span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="mi">7</span><span class="x">)</span><span class="o">...</span><span class="x">)</span>

<span class="c"># Another initializer alias</span>
<span class="n">ParticleNoArr</span><span class="x">{</span><span class="n">T</span><span class="x">}(</span><span class="n">X</span><span class="x">,</span> <span class="n">Gamma</span><span class="x">,</span> <span class="n">sigma</span><span class="x">)</span> <span class="n">where</span> <span class="n">T</span> <span class="o">=</span> <span class="n">ParticleNoArr</span><span class="x">(</span><span class="n">X</span><span class="o">...</span><span class="x">,</span> <span class="n">Gamma</span><span class="o">...</span><span class="x">,</span> <span class="n">sigma</span><span class="x">);</span></code></pre></figure>

<p>With that twist, now we implement <code class="highlighter-rouge">@simd</code> in the internal for loop, while both
<code class="highlighter-rouge">@fastmath</code> and <code class="highlighter-rouge">@inbounds</code> wrap all floating point operations and output
allocation:</p>

<p><strong>In [50]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="s">"""
    Implementation of @simd, @fastmath, and @inbounds
"""</span>
<span class="k">function</span><span class="nf"> P2P_FINAL</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span><span class="x">)</span>

    <span class="k">for</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="n">Pi</span><span class="x">)</span> <span class="k">in</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">particles</span><span class="x">)</span>
        <span class="nd">@simd</span> <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>

            <span class="nd">@fastmath</span> <span class="nd">@inbounds</span> <span class="k">begin</span>
                <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X1</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X1</span>
                <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X2</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X2</span>
                <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X3</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X3</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

                <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                    <span class="c"># g_σ and ∂gσ∂r</span>
                    <span class="n">gsgm</span><span class="x">,</span> <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">g_dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                    <span class="c"># K × Γp</span>
                    <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="x">)</span>
                    <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="x">)</span>
                    <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="x">)</span>

                    <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                    <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                    <span class="c"># Adds the Kronecker delta term</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>

                <span class="k">end</span>
            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p><strong>In [51]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Create a 6x6x6 box of particles of our new ParticleNoArr struct</span>
<span class="n">particlesNoArr</span> <span class="o">=</span> <span class="n">generate_particles</span><span class="x">(</span><span class="n">ParticleNoArr</span><span class="x">{</span><span class="kt">Float64</span><span class="x">},</span> <span class="n">n</span><span class="x">,</span> <span class="n">lambda</span><span class="x">)</span>

<span class="c"># Pre-allocate outputs in separate arrays</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">zeros</span><span class="x">(</span><span class="kt">Float64</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">length</span><span class="x">(</span><span class="n">particlesNoArr</span><span class="x">)</span> <span class="x">)</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">zeros</span><span class="x">(</span><span class="kt">Float64</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">length</span><span class="x">(</span><span class="n">particlesNoArr</span><span class="x">)</span> <span class="x">)</span>

<span class="c"># Run benchmark</span>
<span class="n">args</span> <span class="o">=</span> <span class="x">(</span><span class="n">particlesNoArr</span><span class="x">,</span> <span class="n">g_dgdr_wnk</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span><span class="x">)</span>
<span class="n">compare</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="n">P2P_reusesqrt</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span>

<span class="nd">@benchmark</span> <span class="n">P2P_FINAL</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">);</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_FINAL            is  1.14 times faster than        P2P_reusesqrt (3.552ms vs 4.050ms)

BenchmarkTools.Trial:
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     3.552 ms (0.00% GC)
  median time:      4.090 ms (0.00% GC)
  mean time:        4.056 ms (0.00% GC)
  maximum time:     4.761 ms (0.00% GC)
  --------------
  samples:          247
  evals/sample:     1
</code></pre></div></div>

<p>Comparing to C++, <strong>our Julia code is now as fast —and a little
faster—than C++:</strong></p>

<p><strong>In [52]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">true</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_FINAL            is  1.12 times faster than                  C++ (3.552ms vs 3.996ms)
</code></pre></div></div>

<p>However, our Julia code is using clang’s fastmath compilation mode. A more fair
comparison is done by also compiling C++ with the <code class="highlighter-rouge">-ffast-math</code> flag in addition
to <code class="highlighter-rouge">-O3</code>, which I have coded, compiled, and wrapped in this
<a href="https://github.com/JuliaInterop/CxxWrap.jl">CxxWrap</a>:</p>

<p><strong>In [34]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="c"># Run C++ benchmark with -ffast-math flag</span>
<span class="n">cpptime</span> <span class="o">=</span> <span class="n">CxxVortexTestFASTMATH</span><span class="o">.</span><span class="n">benchmarkP2P_wrap</span><span class="x">(</span><span class="n">ntests</span><span class="x">,</span> <span class="n">n</span><span class="x">,</span> <span class="kt">Float32</span><span class="x">(</span><span class="n">lambda</span><span class="x">),</span> <span class="n">verbose</span><span class="x">)</span>

<span class="c"># Store benchmark result</span>
<span class="n">benchtime</span><span class="x">[</span><span class="s">"C++ -ffast-math"</span><span class="x">]</span> <span class="o">=</span> <span class="n">cpptime</span><span class="x">;</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Samples:	1000
min time:	1.40114 ms
ave time:	1.72617 ms
max time:	2.71737 ms
</code></pre></div></div>

<p><strong>In [53]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++ -ffast-math"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++ -ffast-math      is  2.54 times faster than            P2P_FINAL (1.401ms vs 3.552ms)
</code></pre></div></div>

<p>And once again, <code class="highlighter-rouge">-ffast-math</code> places C++ at a modest 2.5x over the optimized
Julia code; but be not discouraged, we are talking about a dynamic-like language
that is <strong>only 0.4x slower than C++</strong>! =]</p>

<p><strong>NOTE:</strong> In a subsequent test I commented out the two power operations (<code class="highlighter-rouge">r =
sqrt(...)</code> and <code class="highlighter-rouge">gsgm, dgsgmdr = g_dgdr(r/Pj.sigma)</code>) and the resulting wall-
clock time went down from 6.35ms to 0.496ms, meaning that at this stage the
overhead is on non-algebraic operations and that the function could further be
optimized only by finding a more efficient way of calculation powers in Julia.</p>

<h2 id="julia-as-fast-as-c">Julia as Fast as C++</h2>

<p>Finally, let’s take a second to compare where we started and where we ended. Our
initial Julia function was very compact and understandable, however it was more
than 50x slower than its C++ counterpart:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="s">"""
    Pythonic programming approach
"""</span>
<span class="k">function</span><span class="nf"> P2P_pythonic</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g</span><span class="x">,</span> <span class="n">dgdr</span><span class="x">)</span>

    <span class="k">for</span> <span class="n">Pi</span> <span class="k">in</span> <span class="n">particles</span>
        <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>

            <span class="n">dX</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">norm</span><span class="x">(</span><span class="n">dX</span><span class="x">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                <span class="c"># g_σ and ∂gσ∂r</span>
                <span class="n">gsgm</span> <span class="o">=</span> <span class="n">g</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>
                <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                <span class="c"># K × Γp</span>
                <span class="n">crss</span> <span class="o">=</span> <span class="n">cross</span><span class="x">(</span><span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="x">(</span><span class="n">dX</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">),</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span>

                <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                <span class="n">Pi</span><span class="o">.</span><span class="n">U</span><span class="x">[</span><span class="o">:</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss</span>

                <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span>
                    <span class="n">Pi</span><span class="o">.</span><span class="n">J</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">j</span><span class="x">]</span> <span class="o">+=</span> <span class="x">(</span> <span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span> <span class="o">/</span> <span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span> <span class="o">*</span> <span class="x">(</span><span class="n">dgsgmdr</span><span class="o">*</span><span class="n">crss</span><span class="x">)</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="mi">3</span><span class="o">*</span><span class="n">dX</span><span class="x">[</span><span class="n">j</span><span class="x">]</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="x">)</span> <span class="o">*</span> <span class="n">crss</span> <span class="o">-</span>
                                      <span class="n">gsgm</span> <span class="o">*</span> <span class="x">(</span><span class="n">const4</span><span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">3</span><span class="x">)</span> <span class="o">*</span> <span class="n">cross</span><span class="x">([</span><span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="x">],</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma</span><span class="x">)</span> <span class="x">)</span>
                <span class="k">end</span>

            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p><strong>In [48]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_pythonic</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C++                  is 58.48 times faster than         P2P_pythonic (3.996ms vs 233.679ms)
</code></pre></div></div>

<p>After all the optimization we end up with about twice the amount of lines, but
65x faster that the original version and only 2.5x slower than C++ with
<code class="highlighter-rouge">-ffastmath</code>:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
    Optimized Julia code
"""</span>
<span class="k">function</span><span class="nf"> P2P_FINAL</span><span class="x">(</span><span class="n">particles</span><span class="x">,</span> <span class="n">g_dgdr</span><span class="x">,</span> <span class="n">U</span><span class="x">,</span> <span class="n">J</span><span class="x">)</span>

    <span class="k">for</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="n">Pi</span><span class="x">)</span> <span class="k">in</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">particles</span><span class="x">)</span>
        <span class="nd">@simd</span> <span class="k">for</span> <span class="n">Pj</span> <span class="k">in</span> <span class="n">particles</span>

            <span class="nd">@fastmath</span> <span class="nd">@inbounds</span> <span class="k">begin</span>
                <span class="n">dX1</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X1</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X1</span>
                <span class="n">dX2</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X2</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X2</span>
                <span class="n">dX3</span> <span class="o">=</span> <span class="n">Pi</span><span class="o">.</span><span class="n">X3</span> <span class="o">-</span> <span class="n">Pj</span><span class="o">.</span><span class="n">X3</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="x">(</span><span class="n">dX1</span><span class="o">*</span><span class="n">dX1</span> <span class="o">+</span> <span class="n">dX2</span><span class="o">*</span><span class="n">dX2</span> <span class="o">+</span> <span class="n">dX3</span><span class="o">*</span><span class="n">dX3</span><span class="x">)</span>

                <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span>

                    <span class="c"># g_σ and ∂gσ∂r</span>
                    <span class="n">gsgm</span><span class="x">,</span> <span class="n">dgsgmdr</span> <span class="o">=</span> <span class="n">g_dgdr</span><span class="x">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="x">)</span>

                    <span class="c"># K × Γp</span>
                    <span class="n">crss1</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="o">-</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="x">)</span>
                    <span class="n">crss2</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX3</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="o">-</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span> <span class="x">)</span>
                    <span class="n">crss3</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span> <span class="x">(</span> <span class="n">dX1</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span> <span class="o">-</span> <span class="n">dX2</span><span class="o">*</span><span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span> <span class="x">)</span>

                    <span class="c"># U = ∑g_σ(x-xp) * K(x-xp) × Γp</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss1</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss2</span>
                    <span class="n">U</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">gsgm</span> <span class="o">*</span> <span class="n">crss3</span>

                    <span class="c"># ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp ]</span>
                    <span class="c"># ∂u∂xj(x) += ∑p[(Δxj∂gσ∂r/(σr) − 3Δxjgσ/r^2) K(Δx)×Γp</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="n">dgsgmdr</span><span class="o">/</span><span class="x">(</span><span class="n">Pj</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="x">)</span><span class="o">*</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">gsgm</span> <span class="o">/</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX1</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX2</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss1</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss2</span> <span class="o">*</span> <span class="n">dX3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">crss3</span> <span class="o">*</span> <span class="n">dX3</span>

                    <span class="c"># Adds the Kronecker delta term</span>
                    <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span><span class="n">const4</span> <span class="o">*</span> <span class="n">gsgm</span> <span class="o">/</span> <span class="n">r</span><span class="o">^</span><span class="mi">3</span>
                    <span class="c"># j=1</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="c"># j=2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">3</span><span class="x">,</span> <span class="mi">2</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>
                    <span class="c"># j=3</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">1</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma2</span>
                    <span class="n">J</span><span class="x">[</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="n">i</span><span class="x">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">Pj</span><span class="o">.</span><span class="n">Gamma1</span>

                <span class="k">end</span>
            <span class="k">end</span>

        <span class="k">end</span>
    <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p><strong>In [54]:</strong></p>

<figure class="highlight"><pre><code class="language-julia" data-lang="julia"><span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="n">P2P_pythonic</span><span class="x">,</span> <span class="nb">true</span><span class="x">)</span>
<span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++"</span><span class="x">,</span> <span class="nb">true</span><span class="x">)</span>
<span class="n">printcomparison</span><span class="x">(</span><span class="n">P2P_FINAL</span><span class="x">,</span> <span class="s">"C++ -ffast-math"</span><span class="x">,</span> <span class="nb">false</span><span class="x">)</span></code></pre></figure>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>P2P_FINAL            is 65.79 times faster than         P2P_pythonic (3.552ms vs 233.679ms)
P2P_FINAL            is  1.12 times faster than                  C++ (3.552ms vs 3.996ms)
C++ -ffast-math      is  2.54 times faster than            P2P_FINAL (1.401ms vs 3.552ms)
</code></pre></div></div>

<p>Oddly enough, through the optimization process we naturally morphed the code
into something that looks very similar to the C++ version:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Particle-to-particle interactions</span>
<span class="kt">void</span> <span class="nf">P2P</span><span class="p">(</span><span class="n">Particle</span> <span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">numParticles</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">real_t</span> <span class="n">r</span><span class="p">,</span> <span class="n">ros</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">g_sgm</span><span class="p">,</span> <span class="n">dgdr</span><span class="p">;</span>
  <span class="n">vec3</span> <span class="n">dX</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">numParticles</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

      <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
          <span class="n">ros</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="p">;</span>

          <span class="c1">// Evaluate g_σ and ∂gσ∂r</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span>
          <span class="n">g_sgm</span> <span class="o">=</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">dgdr</span> <span class="o">=</span> <span class="mf">7.5</span> <span class="o">*</span> <span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">/</span> <span class="p">(</span> <span class="n">aux</span> <span class="o">*</span> <span class="p">(</span><span class="n">ros</span><span class="o">*</span><span class="n">ros</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">);</span>

          <span class="c1">// u(x) = ∑g_σ(x−xp) K(x−xp) × Γp</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="n">g_sgm</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">U</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">;</span>

          <span class="c1">// ∂u∂xj(x) = ∑[ ∂gσ∂xj(x−xp) * K(x−xp)×Γp + gσ(x−xp) * ∂K∂xj(x−xp)×Γp]</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">const4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">dgdr</span><span class="o">/</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">sigma</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">g_sgm</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">));</span>
          <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">){</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
            <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">*</span><span class="n">aux</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="c1">// Adds the Kronecker delta term</span>
          <span class="n">aux</span> <span class="o">=</span> <span class="o">-</span> <span class="n">const4</span> <span class="o">*</span> <span class="n">g_sgm</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">);</span>
          <span class="c1">// k=1</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="c1">// k=2</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="c1">// k=3</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">J</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">aux</span> <span class="o">*</span> <span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>In conclusion, if you are trying to get a piece of code fit for high-performance
computing, my recommendation is to <strong>forget about elegant and line-efficient
coding (“pythonic” some would say), and code in C++-esque style from the
beginning</strong>.</p>

<h2 id="conclusions">Conclusions</h2>

<ul>
  <li>
    <p>Without foreknowledge of the types to be handled, Julia can’t optimize the
code during compilation. Multiple dispatch and JIT will compile a well-defined
version of every function based on the arguments that is given on the fly, but
this is not the case for structs properties. <strong>Always define your structs with
its <a href="https://docs.julialang.org/en/v1/manual/performance-tips/index.html#Type-
declarations-1">properties explicitely specified as concrete
types</a></strong>.</p>
  </li>
  <li>
    <p><a href="https://docs.julialang.org/en/v1/manual/performance-
tips/index.html#man-code-warntype-1"><code class="highlighter-rouge">@code_warntype</code></a> is your best friend when trying to catch
abstract types in your code.</p>
  </li>
  <li>
    <p><strong>Avoid memory allocation:</strong> If your function is allocating an insane amount
of memory, that’s an indication that you are saving yourself some lines of code
while sacrificing computation efficiency (<em>e.g.,</em> inline list-comprehension
operations or array algebra instead of unrolling the operations
into explicit code). I recommend using
<a href="https://docs.julialang.org/en/v1/manual/performance-tips/index.html
#Measure-performance-with-[@time](@ref)-and-pay-attention-to-memory-
allocation-1"><code class="highlighter-rouge">@time</code></a> or <a href="https://github.com/JuliaCI/BenchmarkTools.jl/blo
b/master/doc/manual.md"><code class="highlighter-rouge">@benchmark</code></a> to check memory allocation.</p>
  </li>
  <li>
    <p><strong>Avoid storing intermediate calculations in internal arrays, just use Float
variables</strong>. For some reason Julia spends a lot of time trying to allocate space
for internal arrays.</p>
  </li>
  <li>
    <p>Any <strong>non-integer power operations (<code class="highlighter-rouge">^</code> or <code class="highlighter-rouge">sqrt</code>) are very expensive</strong> in
Julia. If possible, reduce these operations by storing and reusing previous
calculations.</p>
  </li>
  <li>
    <p>At all cost, <strong>avoid using functions from the LinearAlgebra package</strong>
(like <code class="highlighter-rouge">dot</code>, <code class="highlighter-rouge">cross</code>, <code class="highlighter-rouge">norm</code>) as they will require allocating memory for
internal arrays.</p>
  </li>
  <li>
    <p>For some reason,
<a href="https://docs.julialang.org/en/v1/base/base/#Base.SimdLoop.@simd"><code class="highlighter-rouge">@simd</code></a>,
<a href="https://docs.julialang.org/en/v1/base/math/#Base.FastMath.@fastmath"><code class="highlighter-rouge">@fastmath</code></a>,
and <a href="https://docs.julialang.org/en/v1/base/base/#Base.@inbounds"><code class="highlighter-rouge">@inbounds</code></a>
speed up your code only when working with <code class="highlighter-rouge">isbits</code> types.</p>
  </li>
  <li>
    <p><strong>Forget about elegant and line-efficient coding (“pythonic” some would say),
and code in C++-esque style</strong> in parts of the code where performance is
critical.</p>
  </li>
</ul>

<h3 id="notes">Notes</h3>

<ul>
  <li>This benchmark was done in a Dell Latitude 5580 laptop (Intel® Core™ i7-7820HQ
CPU @ 2.90GHz × 8 ) in only one process.</li>
  <li>Julia v1.0.3 was used.</li>
  <li>The official <a href="https://docs.julialang.org/en/v1/manual
/performance-tips/index.html">Julia documentation</a> also provide very useful tips for performance.</li>
  <li>The code used in this post is available here:
<a href="https://github.com/EdoAlvarezR/post-juliavscpp">https://github.com/EdoAlvarezR/post-juliavscpp</a></li>
</ul>

<h3 id="references">References</h3>

<ol>
  <li>Winckelmans, G. S., &amp; Leonard, A. (1993). Contributions to Vortex Particle
Methods for the Computation of Three-Dimensional Incompressible Unsteady Flows.
Journal of Computational Physics, 109(2), 247–273.
https://doi.org/10.1006/jcph.1993.1216</li>
  <li>Alvarez, E. J., &amp; Ning, A. (2018). Development of a Vortex Particle Code for
the Modeling of Wake Interaction in Distributed Propulsion. In 2018 Applied
Aerodynamics Conference (pp. 1–22). American Institute of Aeronautics and
Astronautics. https://doi.org/10.2514/6.2018-3646 . <a href="https://scholarsarchive.byu.edu/facpub/2116/">PDF
Available</a></li>
</ol>
 -->
<!-- 

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/posts/vawt-wake">
            Development of a Vertical-Axis Wind Turbine Wake Model
            <small>05 Jun 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/pc-windfarm">
            Polynomial Chaos for Wind Farm Power Prediction
            <small>28 May 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/coupled-turbine-farm">
            Coupled Wind Turbine Design and Layout Optimization
            <small>13 Feb 2019</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div> -->

    </div>

  </body>
</html>
